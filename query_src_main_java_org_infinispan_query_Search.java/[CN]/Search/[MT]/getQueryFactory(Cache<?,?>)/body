{
  if (cache == null || cache.getAdvancedCache() == null) {
    throw new IllegalArgumentException("cache parameter shall not be null");
  }
  AdvancedCache<?,?> advancedCache=cache.getAdvancedCache();
  ensureAccessPermissions(advancedCache);
  Configuration cacheConfiguration=SecurityActions.getCacheConfiguration(advancedCache);
  if (cacheConfiguration.indexing().index().isEnabled()) {
    return getSearchManager(advancedCache).unwrap(SearchManagerImplementor.class).getQueryFactory();
  }
  return new EmbeddedQueryFactory(advancedCache);
}
