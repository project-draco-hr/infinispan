{
  if (cache == null || cache.getAdvancedCache() == null) {
    throw new IllegalArgumentException("cache parameter shall not be null");
  }
  AdvancedCache<?,?> advancedCache=cache.getAdvancedCache();
  ensureAccessPermissions(advancedCache);
  QueryEngine queryEngine;
  if (SecurityActions.getCacheConfiguration(advancedCache).indexing().index().isEnabled()) {
    queryEngine=getSearchManager(advancedCache).unwrap(QueryEngine.class);
  }
 else {
    queryEngine=new QueryEngine(advancedCache,null);
  }
  return new EmbeddedQueryFactory(queryEngine);
}
