{
  if (!running) {
    log.debugf("Ignoring rebalance request %s for cache %s, the local cache manager is not running",cacheTopology.getTopologyId(),cacheName);
    return;
  }
  waitForView(viewId);
  LocalCacheStatus cacheStatus=runningCaches.get(cacheName);
  if (cacheStatus == null) {
    log.tracef("Ignoring rebalance %s for cache %s that doesn't exist locally",cacheTopology.getTopologyId(),cacheName);
    return;
  }
synchronized (cacheStatus) {
    CacheTopology existingTopology=cacheStatus.getTopology();
    if (existingTopology != null && cacheTopology.getTopologyId() < existingTopology.getTopologyId()) {
      log.debugf("Ignoring old rebalance for cache %s: %s",cacheName,cacheTopology.getTopologyId());
      return;
    }
    log.debugf("Starting local rebalance for cache %s, topology = %s",cacheName,cacheTopology);
    cacheTopology.logRoutingTableInformation();
    cacheStatus.setTopology(cacheTopology);
  }
  ConsistentHash unionCH=cacheStatus.getJoinInfo().getConsistentHashFactory().union(cacheTopology.getCurrentCH(),cacheTopology.getPendingCH());
  CacheTopologyHandler handler=cacheStatus.getHandler();
  handler.rebalance(new CacheTopology(cacheTopology.getTopologyId(),cacheTopology.getCurrentCH(),unionCH));
}
