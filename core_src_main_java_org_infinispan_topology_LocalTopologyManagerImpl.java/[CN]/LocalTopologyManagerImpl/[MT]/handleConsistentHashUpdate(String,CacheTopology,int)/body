{
  if (!running) {
    log.debugf("Ignoring consistent hash update %s for cache %s, the local cache manager is not running",cacheTopology.getTopologyId(),cacheName);
    return;
  }
  waitForView(viewId);
  LocalCacheStatus cacheStatus=runningCaches.get(cacheName);
  if (cacheStatus == null) {
    log.tracef("Ignoring consistent hash update %s for cache %s that doesn't exist locally",cacheTopology.getTopologyId(),cacheName);
    return;
  }
synchronized (cacheStatus) {
    if (cacheStatus.getTopology() != null && cacheStatus.getTopology().getTopologyId() > cacheTopology.getTopologyId()) {
      log.tracef("Ignoring consistent hash update %s for cache %s, we have already received a newer topology %s",cacheTopology.getTopologyId(),cacheName,cacheStatus.getTopology().getTopologyId());
      return;
    }
    log.debugf("Updating local consistent hash(es) for cache %s: new topology = %s",cacheName,cacheTopology);
    cacheStatus.setTopology(cacheTopology);
    ConsistentHash unionCH=null;
    if (cacheTopology.getPendingCH() != null) {
      unionCH=cacheStatus.getJoinInfo().getConsistentHashFactory().union(cacheTopology.getCurrentCH(),cacheTopology.getPendingCH());
    }
    CacheTopologyHandler handler=cacheStatus.getHandler();
    CacheTopology unionTopology=new CacheTopology(cacheTopology.getTopologyId(),cacheTopology.getCurrentCH(),unionCH);
    unionTopology.logRoutingTableInformation();
    handler.updateConsistentHash(unionTopology);
  }
}
