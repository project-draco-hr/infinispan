{
  if (!(cmd instanceof XSiteReplicateCommand)) {
    throw new IllegalStateException("Only XSiteReplicateCommand commands expected as a result of xsite calls but got " + cmd.getClass().getName());
  }
  if (trace) {
    log.tracef("Handling command %s from remote site %s",cmd,src);
  }
  final BackupReceiver receiver=backupReceiverRepository.getBackupReceiver(src.getSite(),((XSiteReplicateCommand)cmd).getCacheName());
  if (preserveOrder) {
    reply(response,((XSiteReplicateCommand)cmd).performInLocalSite(receiver));
    return;
  }
  remoteCommandsExecutor.execute(new Runnable(){
    @Override public void run(){
      try {
        reply(response,((XSiteReplicateCommand)cmd).performInLocalSite(receiver));
      }
 catch (      InterruptedException e) {
        log.shutdownHandlingCommand(cmd);
        reply(response,new ExceptionResponse(new CacheException("Cache is shutting down")));
      }
catch (      Throwable throwable) {
        log.exceptionHandlingCommand(cmd,throwable);
        reply(response,new ExceptionResponse(new CacheException("Problems invoking command.",throwable)));
      }
    }
  }
);
}
