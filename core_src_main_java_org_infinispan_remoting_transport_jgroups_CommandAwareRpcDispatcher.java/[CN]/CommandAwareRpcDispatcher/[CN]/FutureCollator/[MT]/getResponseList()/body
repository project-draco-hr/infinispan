{
  long expectedEndTime=timeService.expectedEndTime(timeout,MILLISECONDS);
  long waitingTime;
  while (expectedResponses > 0 && retval == null && (waitingTime=timeService.remainingTime(expectedEndTime,MILLISECONDS)) > 0) {
    try {
      this.wait(waitingTime);
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      expectedResponses=-1;
    }
  }
  if (retval != null)   return retval;
 else   if (exception != null)   throw exception;
 else   if (expectedResponses == 0)   throw new RpcException(format("No more valid responses.  Received invalid responses from all of %s",futures.values()));
 else   throw new TimeoutException(format("Timed out waiting for %s for valid responses from any of %s.",Util.prettyPrintTime(timeout),futures.values()));
}
