{
  long giveupTimeNanos=System.nanoTime() + TimeUnit.NANOSECONDS.convert(timeout,TimeUnit.MILLISECONDS);
  boolean notTimedOut=true;
synchronized (this) {
    while (notTimedOut && expectedResponses > 0 && retval == null) {
      notTimedOut=giveupTimeNanos > System.nanoTime();
      this.wait(timeout);
    }
  }
  if (retval != null)   return retval;
 else   if (exception != null)   throw exception;
 else   if (notTimedOut)   throw new RpcException(format("No more valid responses.  Received invalid responses from all of %s",futures.values()));
 else   throw new TimeoutException(format("Timed out waiting for %s for valid responses from any of %s.",Util.prettyPrintTime(timeout),futures.values()));
}
