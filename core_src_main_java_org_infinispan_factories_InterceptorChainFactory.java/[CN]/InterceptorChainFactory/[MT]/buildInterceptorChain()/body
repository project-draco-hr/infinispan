{
  TransactionMode transactionMode=configuration.transaction().transactionMode();
  boolean needsVersionAwareComponents=transactionMode.isTransactional() && Configurations.isVersioningEnabled(configuration);
  InterceptorChain interceptorChain=new InterceptorChain(componentRegistry.getComponentMetadataRepo());
  componentRegistry.registerComponent(interceptorChain,InterceptorChain.class);
  boolean invocationBatching=configuration.invocationBatching().enabled();
  boolean isTotalOrder=configuration.transaction().transactionProtocol().isTotalOrder();
  CacheMode cacheMode=configuration.clustering().cacheMode();
  if (configuration.clustering().cacheMode().isDistributed()) {
    interceptorChain.appendInterceptor(createInterceptor(new DistributionBulkInterceptor<>(),DistributionBulkInterceptor.class),false);
  }
  if (invocationBatching) {
    interceptorChain.appendInterceptor(createInterceptor(new BatchingInterceptor(),BatchingInterceptor.class),false);
  }
  interceptorChain.appendInterceptor(createInterceptor(new InvocationContextInterceptor(),InvocationContextInterceptor.class),false);
  CompatibilityModeConfiguration compatibility=configuration.compatibility();
  if (compatibility.enabled()) {
    Marshaller compatibilityMarshaller=compatibility.marshaller();
    if (compatibilityMarshaller != null) {
      componentRegistry.wireDependencies(compatibilityMarshaller);
    }
    interceptorChain.appendInterceptor(createInterceptor(new TypeConverterInterceptor(compatibilityMarshaller),TypeConverterInterceptor.class),false);
  }
  if (configuration.clustering().async().useReplQueue() || hasAsyncStore())   interceptorChain.appendInterceptor(createInterceptor(new IsMarshallableInterceptor(),IsMarshallableInterceptor.class),false);
  if (configuration.jmxStatistics().available()) {
    interceptorChain.appendInterceptor(createInterceptor(new CacheMgmtInterceptor(),CacheMgmtInterceptor.class),false);
  }
  if (cacheMode.isDistributed() || cacheMode.isReplicated()) {
    if (isTotalOrder) {
      interceptorChain.appendInterceptor(createInterceptor(new TotalOrderStateTransferInterceptor(),TotalOrderStateTransferInterceptor.class),false);
    }
 else {
      interceptorChain.appendInterceptor(createInterceptor(new StateTransferInterceptor(),StateTransferInterceptor.class),false);
    }
    if (transactionMode.isTransactional()) {
      interceptorChain.appendInterceptor(createInterceptor(new TransactionSynchronizerInterceptor(),TransactionSynchronizerInterceptor.class),false);
    }
  }
  if (configuration.clustering().partitionHandling().enabled() && (cacheMode.isDistributed() || cacheMode.isReplicated())) {
    interceptorChain.appendInterceptor(createInterceptor(new PartitionHandlingInterceptor(),PartitionHandlingInterceptor.class),false);
  }
  if (isTotalOrder) {
    interceptorChain.appendInterceptor(createInterceptor(new TotalOrderInterceptor(),TotalOrderInterceptor.class),false);
  }
  if (transactionMode.isTransactional())   interceptorChain.appendInterceptor(createInterceptor(new TxInterceptor(),TxInterceptor.class),false);
  if (isUsingMarshalledValues(configuration)) {
    CommandInterceptor interceptor;
    interceptor=createInterceptor(new MarshalledValueInterceptor(),MarshalledValueInterceptor.class);
    interceptorChain.appendInterceptor(interceptor,false);
  }
  if (transactionMode.isTransactional() && configuration.transaction().notifications()) {
    interceptorChain.appendInterceptor(createInterceptor(new NotificationInterceptor(),NotificationInterceptor.class),false);
  }
  if (configuration.transaction().useEagerLocking()) {
    configuration.transaction().lockingMode(LockingMode.PESSIMISTIC);
  }
  if (!isTotalOrder) {
    if (transactionMode.isTransactional()) {
      if (configuration.transaction().lockingMode() == LockingMode.PESSIMISTIC) {
        interceptorChain.appendInterceptor(createInterceptor(new PessimisticLockingInterceptor(),PessimisticLockingInterceptor.class),false);
      }
 else {
        interceptorChain.appendInterceptor(createInterceptor(new OptimisticLockingInterceptor(),OptimisticLockingInterceptor.class),false);
      }
    }
 else {
      interceptorChain.appendInterceptor(createInterceptor(new NonTransactionalLockingInterceptor(),NonTransactionalLockingInterceptor.class),false);
    }
  }
  if (configuration.sites().hasEnabledBackups() && !configuration.sites().disableBackups()) {
    if (transactionMode == TransactionMode.TRANSACTIONAL) {
      if (configuration.transaction().lockingMode() == LockingMode.OPTIMISTIC) {
        interceptorChain.appendInterceptor(createInterceptor(new OptimisticBackupInterceptor(),OptimisticBackupInterceptor.class),false);
      }
 else {
        interceptorChain.appendInterceptor(createInterceptor(new PessimisticBackupInterceptor(),PessimisticBackupInterceptor.class),false);
      }
    }
 else {
      interceptorChain.appendInterceptor(createInterceptor(new NonTransactionalBackupInterceptor(),NonTransactionalBackupInterceptor.class),false);
    }
  }
  if (configuration.clustering().l1().enabled()) {
    interceptorChain.appendInterceptor(createInterceptor(new L1LastChanceInterceptor(),L1LastChanceInterceptor.class),false);
  }
  if (configuration.clustering().hash().groups().enabled()) {
    interceptorChain.appendInterceptor(createInterceptor(new GroupingInterceptor(),GroupingInterceptor.class),false);
  }
  if (needsVersionAwareComponents && cacheMode.isClustered()) {
    if (isTotalOrder) {
      interceptorChain.appendInterceptor(createInterceptor(new TotalOrderVersionedEntryWrappingInterceptor(),TotalOrderVersionedEntryWrappingInterceptor.class),false);
    }
 else {
      interceptorChain.appendInterceptor(createInterceptor(new VersionedEntryWrappingInterceptor(),VersionedEntryWrappingInterceptor.class),false);
    }
  }
 else   interceptorChain.appendInterceptor(createInterceptor(new EntryWrappingInterceptor(),EntryWrappingInterceptor.class),false);
  if (configuration.persistence().usingStores()) {
    if (configuration.persistence().passivation()) {
      if (cacheMode.isClustered())       interceptorChain.appendInterceptor(createInterceptor(new ClusteredActivationInterceptor(),ClusteredActivationInterceptor.class),false);
 else       interceptorChain.appendInterceptor(createInterceptor(new ActivationInterceptor(),ActivationInterceptor.class),false);
    }
 else {
      if (cacheMode.isClustered())       interceptorChain.appendInterceptor(createInterceptor(new ClusteredCacheLoaderInterceptor(),ClusteredCacheLoaderInterceptor.class),false);
 else       interceptorChain.appendInterceptor(createInterceptor(new CacheLoaderInterceptor(),CacheLoaderInterceptor.class),false);
switch (cacheMode) {
case DIST_SYNC:
case DIST_ASYNC:
case REPL_SYNC:
case REPL_ASYNC:
        interceptorChain.appendInterceptor(createInterceptor(new DistCacheWriterInterceptor(),DistCacheWriterInterceptor.class),false);
      break;
default :
    interceptorChain.appendInterceptor(createInterceptor(new CacheWriterInterceptor(),CacheWriterInterceptor.class),false);
  break;
}
}
}
if (configuration.deadlockDetection().enabled() && !isTotalOrder) {
interceptorChain.appendInterceptor(createInterceptor(new DeadlockDetectingInterceptor(),DeadlockDetectingInterceptor.class),false);
}
if (configuration.clustering().l1().enabled()) {
if (transactionMode.isTransactional()) {
interceptorChain.appendInterceptor(createInterceptor(new L1TxInterceptor(),L1TxInterceptor.class),false);
}
 else {
interceptorChain.appendInterceptor(createInterceptor(new L1NonTxInterceptor(),L1NonTxInterceptor.class),false);
}
}
switch (cacheMode) {
case INVALIDATION_SYNC:
case INVALIDATION_ASYNC:
interceptorChain.appendInterceptor(createInterceptor(new InvalidationInterceptor(),InvalidationInterceptor.class),false);
break;
case DIST_SYNC:
case REPL_SYNC:
if (needsVersionAwareComponents) {
if (isTotalOrder) {
interceptorChain.appendInterceptor(createInterceptor(new TotalOrderVersionedDistributionInterceptor(),TotalOrderVersionedDistributionInterceptor.class),false);
}
 else {
interceptorChain.appendInterceptor(createInterceptor(new VersionedDistributionInterceptor(),VersionedDistributionInterceptor.class),false);
}
break;
}
case DIST_ASYNC:
case REPL_ASYNC:
if (transactionMode.isTransactional()) {
if (isTotalOrder) {
interceptorChain.appendInterceptor(createInterceptor(new TotalOrderDistributionInterceptor(),TotalOrderDistributionInterceptor.class),false);
}
 else {
interceptorChain.appendInterceptor(createInterceptor(new TxDistributionInterceptor(),TxDistributionInterceptor.class),false);
}
}
 else {
interceptorChain.appendInterceptor(createInterceptor(new NonTxDistributionInterceptor(),NonTxDistributionInterceptor.class),false);
}
break;
case LOCAL:
}
CommandInterceptor callInterceptor=createInterceptor(new CallInterceptor(),CallInterceptor.class);
interceptorChain.appendInterceptor(callInterceptor,false);
log.trace("Finished building default interceptor chain.");
buildCustomInterceptors(interceptorChain,configuration.customInterceptors());
return interceptorChain;
}
