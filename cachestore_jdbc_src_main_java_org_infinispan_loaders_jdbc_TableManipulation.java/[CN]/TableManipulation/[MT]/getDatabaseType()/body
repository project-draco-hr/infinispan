{
  if (databaseType == null) {
    Connection connection=null;
    try {
      connection=connectionFactory.getConnection();
      String dbProduct=connection.getMetaData().getDatabaseProductName();
      databaseType=guessDatabaseType(dbProduct);
    }
 catch (    Exception e) {
      log.debug("Unable to guess database type from JDBC metadata.",e);
    }
 finally {
      connectionFactory.releaseConnection(connection);
    }
    if (databaseType == null) {
      log.debug("Unable to detect database type using connection metadata.  Attempting to guess on driver name.");
      try {
        connection=connectionFactory.getConnection();
        String dbProduct=connectionFactory.getConnection().getMetaData().getDriverName();
        databaseType=guessDatabaseType(dbProduct);
      }
 catch (      Exception e) {
        log.debug("Unable to guess database type from JDBC driver name.",e);
      }
 finally {
        connectionFactory.releaseConnection(connection);
      }
    }
    if (databaseType == null) {
      throw new ConfigurationException("Unable to detect database type from JDBC driver name or connection metadata.  Please provide this manually using the 'databaseType' property in your configuration.  Supported database type strings are " + Arrays.toString(DatabaseType.values()));
    }
 else {
      log.debugf("Guessing database type as '%s'.  If this is incorrect, please specify the correct type using the 'databaseType' property in your configuration.  Supported database type strings are %s",databaseType,Arrays.toString(DatabaseType.values()));
    }
  }
  return databaseType;
}
