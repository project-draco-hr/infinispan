{
  if (!isCancelled) {
    isCancelled=true;
    Set<Integer> cancelledSegments=new HashSet<Integer>(segments);
    segments.clear();
    finishedSegments.clear();
    StateRequestCommand cmd=commandsFactory.buildStateRequestCommand(StateRequestCommand.Type.CANCEL_STATE_TRANSFER,rpcManager.getAddress(),topologyId,cancelledSegments);
    rpcManager.invokeRemotely(Collections.singleton(source),cmd,ResponseMode.SYNCHRONOUS_IGNORE_LEAVERS,timeout);
    stateConsumer.onTaskCompletion(this);
  }
}
