{
  final int READ_THREADS=8;
  final int WRITE_THREADS=3;
  final int REMOVE_THREADS=2;
  final int INSERTIONCOUNT=2048;
  final int REMOVECOUNT=200;
  final int READCOUNT=20;
  ExecutorService execService=Executors.newFixedThreadPool(READ_THREADS + WRITE_THREADS + REMOVE_THREADS);
  ExecutorCompletionService<Void> service=new ExecutorCompletionService<Void>(execService);
  try {
    final int COUNT=INSERTIONCOUNT >> 4;
    final int hash=23;
    final Map<HashCodeControlled,HashCodeControlled> bchm=createMap(COUNT,evictionPolicy());
    for (int i=0; i < WRITE_THREADS; ++i) {
      service.submit(new Callable<Void>(){
        @Override public Void call() throws Exception {
          for (int i=0; i < INSERTIONCOUNT; ++i) {
            HashCodeControlled hcc=new HashCodeControlled(hash);
            bchm.put(hcc,hcc);
          }
          return null;
        }
      }
);
    }
    for (int i=0; i < READ_THREADS; ++i) {
      service.submit(new Callable<Void>(){
        @Override public Void call() throws Exception {
          for (int i=0; i < READCOUNT; ++i) {
            for (            Entry<HashCodeControlled,HashCodeControlled> entry : bchm.entrySet()) {
              HashCodeControlled key=entry.getKey();
              bchm.get(key);
            }
          }
          return null;
        }
      }
);
    }
    for (int i=0; i < REMOVE_THREADS; ++i) {
      service.submit(new Callable<Void>(){
        @Override public Void call() throws Exception {
          for (int i=0; i < REMOVECOUNT; ++i) {
            for (            Entry<HashCodeControlled,HashCodeControlled> entry : bchm.entrySet()) {
              HashCodeControlled key=entry.getKey();
              bchm.remove(key);
            }
          }
          return null;
        }
      }
);
    }
    for (int i=0; i < WRITE_THREADS + READ_THREADS + REMOVE_THREADS; ++i) {
      try {
        Future<Void> future=service.poll(10,TimeUnit.SECONDS);
        if (future == null) {
          throw new TimeoutException();
        }
        future.get();
      }
 catch (      Exception e) {
        throw e;
      }
    }
    int manualCount=0;
    for (    Entry<HashCodeControlled,HashCodeControlled> entry : bchm.entrySet()) {
      if (entry.getValue() != null) {
        manualCount++;
      }
    }
    if (bchm.size() != manualCount) {
      System.currentTimeMillis();
    }
    assertEquals(bchm.size(),manualCount);
    if (manualCount > COUNT) {
      assertFalse("Count " + manualCount + " should not be higher than max "+ COUNT,manualCount > COUNT);
    }
  }
  finally {
    execService.shutdown();
    execService.awaitTermination(10,TimeUnit.SECONDS);
  }
}
