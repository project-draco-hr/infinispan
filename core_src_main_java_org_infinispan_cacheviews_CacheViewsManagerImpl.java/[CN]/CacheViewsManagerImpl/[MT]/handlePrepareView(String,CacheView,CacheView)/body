{
  CacheViewInfo cacheViewInfo=viewsInfo.get(cacheName);
  if (cacheViewInfo == null) {
    throw new IllegalStateException(String.format("Received prepare request for cache %s, which is not running",cacheName));
  }
  log.tracef("%s: Preparing cache view %s, committed view is %s",cacheName,pendingView,committedView);
  boolean isLocal=pendingView.contains(self);
  if (!isLocal && !isCoordinator) {
    throw new IllegalStateException(String.format("%s: Received prepare cache view request, but we are not a member. View is %s",cacheName,pendingView));
  }
  CacheView lastCommittedView=cacheViewInfo.getCommittedView();
  if (lastCommittedView.getViewId() > 0 && lastCommittedView.getViewId() != committedView.getViewId()) {
    log.prepareViewIdMismatch(lastCommittedView,committedView);
  }
  cacheViewInfo.prepareView(pendingView);
  if (isLocal) {
    CacheViewListener cacheViewListener=cacheViewInfo.getListener();
    if (cacheViewListener != null) {
      cacheViewListener.prepareView(pendingView,lastCommittedView);
    }
 else {
      throw new IllegalStateException(String.format("%s: Received cache view prepare request after the local node has already shut down",cacheName));
    }
  }
}
