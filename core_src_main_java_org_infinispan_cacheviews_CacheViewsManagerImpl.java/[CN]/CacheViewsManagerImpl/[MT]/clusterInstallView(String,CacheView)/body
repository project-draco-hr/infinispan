{
  CacheViewInfo cacheViewInfo=viewsInfo.get(cacheName);
  boolean success=false;
  try {
    log.debugf("Installing new view %s for cache %s",newView,cacheName);
    clusterPrepareView(cacheName,newView);
    Set<Address> leavers=cacheViewInfo.getPendingChanges().getLeavers();
    if (cacheViewInfo.getPendingView().containsAny(leavers)) {
      log.debugf("Cannot commit cache view %s, some nodes already left the cluster: %s",cacheViewInfo.getPendingView(),leavers);
      return false;
    }
    success=true;
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
catch (  Throwable t) {
    log.cacheViewPrepareFailure(t,newView,cacheName,cacheViewInfo.getCommittedView());
  }
 finally {
    if (!isRunning())     return false;
    if (success) {
      clusterCommitView(cacheName,newView.getViewId(),newView.getMembers(),true);
      log.debugf("Successfully installed view %s for cache %s",newView,cacheName);
    }
 else {
      CacheView previousCommittedView=cacheViewInfo.getCommittedView();
      clusterRollbackView(cacheName,previousCommittedView.getViewId(),newView.getMembers(),true);
      log.debugf("Rolled back to view %s for cache %s",previousCommittedView,cacheName);
    }
  }
  return success;
}
