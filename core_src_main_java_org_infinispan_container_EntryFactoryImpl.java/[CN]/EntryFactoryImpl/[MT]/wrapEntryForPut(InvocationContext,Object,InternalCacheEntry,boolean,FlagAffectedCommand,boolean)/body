{
  CacheEntry cacheEntry=getFromContext(ctx,key);
  MVCCEntry mvccEntry;
  if (cacheEntry != null && cacheEntry.isNull())   cacheEntry=null;
  Metadata providedMetadata=cmd.getMetadata();
  if (cacheEntry != null) {
    mvccEntry=wrapMvccEntryForPut(ctx,key,cacheEntry,providedMetadata,true);
    mvccEntry.undelete(undeleteIfNeeded);
  }
 else {
    InternalCacheEntry ice=(icEntry == null ? getFromContainer(key) : icEntry);
    if (ice != null && cmd.hasFlag(Flag.PUT_FOR_EXTERNAL_READ)) {
      ctx.putLookedUpEntry(key,null);
      return null;
    }
    mvccEntry=ice != null ? wrapInternalCacheEntryForPut(ctx,key,ice,providedMetadata,skipRead) : newMvccEntryForPut(ctx,key,cmd,providedMetadata,skipRead);
  }
  mvccEntry.copyForUpdate(container,localModeWriteSkewCheck);
  return mvccEntry;
}
