{
  CacheEntry cacheEntry=ctx.lookupEntry(key);
  MVCCEntry mvccEntry=null;
  if (createIfAbsent && cacheEntry != null && cacheEntry.isNull())   cacheEntry=null;
  if (cacheEntry != null) {
    if (trace)     log.trace("Exists in context.");
    if (alreadyLocked || acquireLock(ctx,key)) {
      if (cacheEntry instanceof MVCCEntry && (!forRemoval || !(cacheEntry instanceof NullMarkerEntry))) {
        mvccEntry=(MVCCEntry)cacheEntry;
      }
 else {
        mvccEntry=createWrappedEntry(key,cacheEntry.getValue(),false,forRemoval,cacheEntry.getLifespan());
        cacheEntry=mvccEntry;
        ctx.putLookedUpEntry(key,cacheEntry);
      }
      mvccEntry.copyForUpdate(container,writeSkewCheck);
    }
    if (cacheEntry.isRemoved() && createIfAbsent) {
      if (trace)       log.trace("Entry is deleted in current scope.  Need to un-delete.");
      if (mvccEntry != cacheEntry)       mvccEntry=(MVCCEntry)cacheEntry;
      mvccEntry.setRemoved(false);
      mvccEntry.setValid(true);
    }
    return mvccEntry;
  }
 else {
    cacheEntry=container.get(key);
    if (cacheEntry != null) {
      if (trace)       log.trace("Retrieved from container.");
      boolean lockAcquired=acquireLock(ctx,key);
      mvccEntry=wrapExistingEntryForWriting(ctx,key,alreadyLocked,cacheEntry,lockAcquired);
    }
 else     if (createIfAbsent) {
      if (trace)       log.trace("Creating new entry.");
      boolean lockAcquired=false;
      if (!alreadyLocked) {
        lockAcquired=acquireLock(ctx,key);
      }
      if (lockAcquired) {
        cacheEntry=container.get(key);
        if (cacheEntry != null) {
          mvccEntry=wrapExistingEntryForWriting(ctx,key,true,cacheEntry,lockAcquired);
        }
 else {
          mvccEntry=createAndWrapEntryForWriting(ctx,key);
        }
      }
 else {
        mvccEntry=createAndWrapEntryForWriting(ctx,key);
      }
    }
  }
  if (mvccEntry == null && forceLockIfAbsent) {
    if (acquireLock(ctx,key))     ctx.putLookedUpEntry(key,null);
  }
  return mvccEntry;
}
