{
  int[][] nodeChanges={{1,0},{2,0},{0,1},{0,2},{1,1},{2,2},{10,0},{0,10},{10,10}};
  assertSame(baseCH,chf.updateMembers(baseCH,baseCH.getMembers()));
  assertSame(baseCH,chf.rebalance(baseCH));
  int nodeIndex=baseCH.getMembers().size();
  for (int i=0; i < nodeChanges.length; i++) {
    int nodesToAdd=nodeChanges[i][0];
    int nodesToRemove=nodeChanges[i][1];
    if (nodesToRemove > baseCH.getMembers().size())     break;
    List<Address> newMembers=new ArrayList<Address>(baseCH.getMembers());
    for (int k=0; k < nodesToRemove; k++) {
      newMembers.remove(Math.abs(baseCH.getHashFunction().hash(k) % newMembers.size()));
    }
    for (int k=0; k < nodesToAdd; k++) {
      newMembers.add(new TestAddress(nodeIndex++));
    }
    log.debugf("Testing consistent hash modifications iteration %d. Initial CH is %s. New members are %s",iterationCount,baseCH,newMembers);
    DefaultConsistentHash updatedMembersCH=(DefaultConsistentHash)chf.updateMembers(baseCH,newMembers);
    if (nodesToRemove > 0) {
      for (int l=0; l < updatedMembersCH.getNumSegments(); l++) {
        assertTrue(updatedMembersCH.locateOwnersForSegment(l).size() > 0);
      }
    }
    DefaultConsistentHash inclRebalancedCH=(DefaultConsistentHash)chf.rebalance(updatedMembersCH);
    checkDistribution(inclRebalancedCH,false);
    int actualNumOwners=Math.min(inclRebalancedCH.getMembers().size(),inclRebalancedCH.getNumOwners());
    for (int l=0; l < inclRebalancedCH.getNumSegments(); l++) {
      assertTrue(inclRebalancedCH.locateOwnersForSegment(l).size() >= actualNumOwners);
    }
    DefaultConsistentHash exclRebalancedCH=(DefaultConsistentHash)chf.rebalance(updatedMembersCH);
    DefaultConsistentHash exclRebalancedCH2=(DefaultConsistentHash)chf.rebalance(inclRebalancedCH);
    assertEquals(exclRebalancedCH2,exclRebalancedCH);
    checkDistribution(exclRebalancedCH,false);
    assertEquals(exclRebalancedCH.getNumSegments(),baseCH.getNumSegments());
    assertEquals(exclRebalancedCH.getNumOwners(),baseCH.getNumOwners());
    assertEquals(exclRebalancedCH.getMembers(),newMembers);
    baseCH=exclRebalancedCH;
    iterationCount++;
  }
}
