{
  Metadata metadata;
  Object value;
  if (cacheEntry != null) {
    value=cacheEntry.getValue();
    Metadata entryMetadata=cacheEntry.getMetadata();
    if (providedMetadata != null && entryMetadata != null) {
      metadata=Metadatas.applyVersion(entryMetadata,providedMetadata);
    }
 else     if (providedMetadata == null) {
      metadata=entryMetadata;
    }
 else {
      metadata=providedMetadata;
    }
    if (context.isOriginLocal() && context.isInTxScope()) {
      ((TxInvocationContext)context).getCacheTransaction().addVersionRead(key,skipRead ? null : metadata.version());
    }
  }
 else {
    value=null;
    metadata=providedMetadata == null ? new EmbeddedMetadata.Builder().version(versionGenerator.nonExistingVersion()).build() : providedMetadata;
    if (context.isOriginLocal() && context.isInTxScope()) {
      ((TxInvocationContext)context).getCacheTransaction().addVersionRead(key,skipRead ? null : versionGenerator.nonExistingVersion());
    }
  }
  MVCCEntry entry=new ClusteredRepeatableReadEntry(key,value,metadata);
  if (forRemoval) {
    entry.setRemoved(true);
  }
  return entry;
}
