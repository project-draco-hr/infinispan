{
  InvocationContext invocationContext;
  boolean txInjected=false;
  if (config.isTransactionalCache()) {
    Transaction transaction=getOngoingTransaction();
    if (transaction == null && config.isTransactionAutoCommit()) {
      try {
        transactionManager.begin();
        transaction=transactionManager.getTransaction();
        txInjected=true;
        if (log.isTraceEnabled())         log.trace("Transaction injected!");
      }
 catch (      Exception e) {
        throw new CacheException("Could not start transaction",e);
      }
    }
    invocationContext=getInvocationContext(transaction,explicitFlags,explicitClassLoader);
  }
 else {
    invocationContext=getInvocationContextForWrite(explicitFlags,explicitClassLoader);
  }
  if (txInjected) {
    ((TxInvocationContext)invocationContext).setTransactionInjected(true);
    if (log.isTraceEnabled())     log.tracef("Marked tx as injected.");
  }
  return invocationContext;
}
