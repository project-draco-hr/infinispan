{
  InvocationContext invocationContext;
  boolean txInjected=false;
  final boolean isPutForExternalRead=isPutForExternalRead(explicitFlags);
  if (config.transaction().transactionMode().isTransactional() && !isPutForExternalRead) {
    Transaction transaction=getOngoingTransaction();
    if (transaction == null && config.transaction().autoCommit()) {
      try {
        transactionManager.begin();
        transaction=transactionManager.getTransaction();
        txInjected=true;
        if (trace)         log.trace("Implicit transaction started!");
      }
 catch (      Exception e) {
        throw new CacheException("Could not start transaction",e);
      }
    }
    invocationContext=getInvocationContext(transaction,explicitFlags,explicitClassLoader);
  }
 else {
    invocationContext=getInvocationContextForWrite(explicitFlags,explicitClassLoader,keyCount,isPutForExternalRead);
  }
  if (txInjected) {
    ((TxInvocationContext)invocationContext).setImplicitTransaction(true);
    if (trace)     log.tracef("Marked tx as implicit.");
  }
  return invocationContext;
}
