{
  InvocationContext invocationContext;
  boolean txInjected=false;
  if (config.transaction().transactionMode().isTransactional() && !isPutForExternalRead) {
    Transaction transaction=getOngoingTransaction();
    if (transaction == null && config.transaction().autoCommit()) {
      try {
        transactionManager.begin();
        transaction=transactionManager.getTransaction();
        txInjected=true;
        if (trace)         log.trace("Implicit transaction started!");
      }
 catch (      Exception e) {
        throw new CacheException("Could not start transaction",e);
      }
    }
    invocationContext=getInvocationContext(transaction,explicitClassLoader,txInjected);
  }
 else {
    invocationContext=getInvocationContextForWrite(explicitClassLoader,keyCount,isPutForExternalRead);
  }
  return invocationContext;
}
