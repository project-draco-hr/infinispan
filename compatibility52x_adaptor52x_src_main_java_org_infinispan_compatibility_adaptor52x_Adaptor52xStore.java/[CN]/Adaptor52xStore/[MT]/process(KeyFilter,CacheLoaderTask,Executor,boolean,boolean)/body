{
  try {
    Set<Object> keys=loader.loadAllKeys(null);
    int batchSize=1000;
    ExecutorAllCompletionService eacs=new ExecutorAllCompletionService(executor);
    final TaskContext taskContext=new TaskContextImpl();
    Set<Object> entries=new HashSet<Object>(batchSize);
    for (    Object key : keys) {
      if (keyFilter == null || keyFilter.shouldLoadKey(key))       entries.add(key);
      if (entries.size() == batchSize) {
        final Set<Object> batch=entries;
        entries=new HashSet<Object>(batchSize);
        submitProcessTask(cacheLoaderTask,eacs,taskContext,batch,fetchValue,fetchMetadata);
      }
    }
    if (!entries.isEmpty()) {
      submitProcessTask(cacheLoaderTask,eacs,taskContext,entries,fetchValue,fetchMetadata);
    }
    eacs.waitUntilAllCompleted();
    if (eacs.isExceptionThrown()) {
      throw newCacheLoaderException(eacs.getFirstException());
    }
  }
 catch (  CacheLoaderException e) {
    throw newCacheLoaderException(e);
  }
}
