{
  JChannel channel=new MuxChannel(this);
  TP transport=channel.getProtocolStack().getTransport();
  if (transport.isSingleton()) {
synchronized (transport) {
      this.init(transport);
    }
  }
 else {
    this.init(transport);
  }
  final RelayConfiguration relayConfig=this.configuration.getRelay();
  if (relayConfig != null) {
    final String localSite=relayConfig.getSiteName();
    final List<RemoteSiteConfiguration> remoteSites=this.configuration.getRelay().getRemoteSites();
    final List<String> sites=new ArrayList<String>(remoteSites.size() + 1);
    sites.add(localSite);
    final Map<String,RelayConfig.BridgeConfig> bridges=new HashMap<String,RelayConfig.BridgeConfig>();
    for (    final RemoteSiteConfiguration remoteSite : remoteSites) {
      final String siteName=remoteSite.getName();
      sites.add(siteName);
      final String cluster=remoteSite.getCluster();
      final String clusterName=(cluster != null) ? cluster : siteName;
      final RelayConfig.BridgeConfig bridge=new RelayConfig.BridgeConfig(clusterName){
        @Override public JChannel createChannel() throws Exception {
          return (JChannel)remoteSite.getChannelFactory().createChannel(id + "/" + clusterName);
        }
      }
;
      bridges.put(clusterName,bridge);
    }
    Collections.sort(sites);
    final RELAY2 relay=new RELAY2().site(localSite);
    for (short i=0; i < sites.size(); ++i) {
      final String site=sites.get(i);
      RelayConfig.SiteConfig siteConfig=new RelayConfig.SiteConfig(site);
      relay.addSite(site,siteConfig);
      if (site.equals(localSite)) {
        for (        RelayConfig.BridgeConfig bridge : bridges.values()) {
          siteConfig.addBridge(bridge);
        }
      }
    }
    Configurator.resolveAndAssignFields(relay,relayConfig.getProperties());
    Configurator.resolveAndInvokePropertyMethods(relay,relayConfig.getProperties());
    channel.getProtocolStack().addProtocol(relay);
    relay.init();
  }
  final SaslConfiguration saslConfig=this.configuration.getSasl();
  if (saslConfig != null) {
    final String clusterRole=saslConfig.getClusterRole();
    final SecurityRealm securityRealm=saslConfig.getSecurityRealm();
    final String mech=saslConfig.getMech();
    final SASL sasl=new SASL();
    sasl.setMech(mech);
    Map<String,String> props=saslConfig.getProperties();
    if (props.containsKey("client_password")) {
      String credential=props.get("client_password");
      String name=props.get("client_name");
      if (name == null) {
        sasl.setClientCallbackHandler(new SaslClientCallbackHandler(securityRealm.getName(),this.configuration.getEnvironment().getNodeName(),credential));
      }
 else       if (name.contains("@")) {
        sasl.setClientCallbackHandler(new SaslClientCallbackHandler(name,credential));
      }
 else {
        sasl.setClientCallbackHandler(new SaslClientCallbackHandler(securityRealm.getName(),name,credential));
      }
    }
 else {
      props.put("client_password","");
    }
    Map<String,String> saslProps=props.containsKey("sasl_props") ? Util.parseCommaDelimitedProps(props.get("sasl_props")) : new HashMap<String,String>();
    sasl.setServerCallbackHandler(new RealmAuthorizationCallbackHandler(securityRealm,mech,clusterRole != null ? clusterRole : id,saslProps));
    props.put("sasl_props",new PropertyConverters.StringProperties().toString(saslProps));
    Configurator.resolveAndAssignFields(sasl,props);
    Configurator.resolveAndInvokePropertyMethods(sasl,props);
    channel.getProtocolStack().insertProtocol(sasl,ProtocolStack.BELOW,GMS.class);
    sasl.init();
  }
  channel.setName(this.configuration.getEnvironment().getNodeName() + "/" + id);
  TransportConfiguration.Topology topology=this.configuration.getTransport().getTopology();
  if (topology != null) {
    channel.setAddressGenerator(new TopologyAddressGenerator(channel,topology.getSite(),topology.getRack(),topology.getMachine()));
  }
  MBeanServer server=this.configuration.getMBeanServer();
  if (server != null) {
    try {
      this.channels.put(channel,id);
      JmxConfigurator.registerChannel(channel,server,id);
    }
 catch (    Exception e) {
      ROOT_LOGGER.warn(e.getMessage(),e);
    }
    channel.addChannelListener(this);
  }
  return channel;
}
