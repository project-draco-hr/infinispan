{
  if (configuration.getTransportClass() != null) {
    Properties newTransportProps=new Properties();
    Properties previousSettings=configuration.getTransportProperties();
    if (previousSettings != null) {
      newTransportProps.putAll(previousSettings);
    }
    String fullTestName=perThreadCacheManagers.get().fullTestName;
    String nextCacheName=perThreadCacheManagers.get().getNextCacheName();
    if (fullTestName == null) {
      String threadName=Thread.currentThread().getName();
      String pattern="TestNGInvoker-";
      if (threadName.startsWith(pattern)) {
        fullTestName=threadName;
        nextCacheName=threadName.substring(threadName.indexOf("-") + 1,threadName.indexOf('('));
      }
    }
    newTransportProps.put(JGroupsTransport.CONFIGURATION_STRING,getJGroupsConfig(fullTestName,withFD));
    configuration.setTransportProperties(newTransportProps);
    configuration.setTransportNodeName(nextCacheName);
  }
}
