{
  MarshalledValue key=null;
  MarshalledValue value=null;
  if (wrapKeys) {
    if (!isTypeExcluded(command.getKey().getClass())) {
      key=createMarshalledValue(command.getKey(),ctx);
      command.setKey(key);
    }
  }
  if (wrapValues) {
    if (!isTypeExcluded(command.getValue().getClass())) {
      value=createMarshalledValue(command.getValue(),ctx);
      command.setValue(value);
    }
  }
  boolean isRawComparisonRequired=!ctx.isOriginLocal() && command.getKey() instanceof MarshalledValue;
  if (isRawComparisonRequired)   ((MarshalledValue)command.getKey()).setEqualityPreferenceForInstance(false);
  try {
    Object retVal=invokeNextInterceptor(ctx,command);
    compact(key);
    compact(value);
    return processRetVal(retVal,ctx);
  }
  finally {
    if (isRawComparisonRequired)     ((MarshalledValue)command.getKey()).setEqualityPreferenceForInstance(true);
  }
}
