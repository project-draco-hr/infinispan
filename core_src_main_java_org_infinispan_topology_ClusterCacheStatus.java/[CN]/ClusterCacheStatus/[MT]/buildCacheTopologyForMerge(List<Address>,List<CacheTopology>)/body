{
  log.trace("Building cache topology for merge.");
  int maxTopology=0;
  ConsistentHash agreedCh=null;
  ConsistentHashFactory chFactory=getJoinInfo().getConsistentHashFactory();
  for (  CacheTopology topology : partitionTopologies) {
    if (topology.getTopologyId() > maxTopology) {
      maxTopology=topology.getTopologyId();
      agreedCh=topology.getCurrentCH();
    }
  }
  updateClusterMembers(clusterMembers);
  List<Address> members=getMembers();
  if (members.isEmpty()) {
    log.tracef("Cache %s has no members left, skipping topology update",cacheName);
    return null;
  }
  if (agreedCh != null) {
    agreedCh=chFactory.updateMembers(agreedCh,members,getCapacityFactors());
    log.tracef("Agreed routing table is %s",agreedCh.getRoutingTableAsString());
  }
  maxTopology+=2;
  CacheTopology cacheTopology=new CacheTopology(maxTopology,agreedCh,null);
  return cacheTopology;
}
