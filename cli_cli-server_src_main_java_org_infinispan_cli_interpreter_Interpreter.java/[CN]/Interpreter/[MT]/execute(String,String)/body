{
  Session session=null;
  ClassLoader oldCL=SysPropertyActions.setThreadContextClassLoader(cacheManager.getCacheManagerConfiguration().classLoader());
  Map<String,String> response=new HashMap<String,String>();
  try {
    session=validateSession(sessionId);
    CharStream stream=new ANTLRStringStream(s);
    IspnQLLexer lexer=new IspnQLLexer(stream);
    CommonTokenStream tokens=new CommonTokenStream(lexer);
    IspnQLParser parser=new IspnQLParser(tokens);
    parser.statements();
    session=sessions.get(sessionId);
    StringBuilder output=new StringBuilder();
    for (    Statement stmt : parser.statements) {
      Result result=stmt.execute(session);
      if (result != EmptyResult.RESULT) {
        output.append(result.getResult());
      }
    }
    if (output.length() > 0) {
      response.put(ResultKeys.OUTPUT.toString(),output.toString());
    }
  }
 catch (  Throwable t) {
    log.interpreterError(t);
    response.put(ResultKeys.ERROR.toString(),t.getMessage());
    StringWriter sw=new StringWriter();
    PrintWriter pw=new PrintWriter(sw);
    t.printStackTrace(pw);
    response.put(ResultKeys.STACKTRACE.toString(),sw.toString());
  }
 finally {
    if (session != null) {
      session.reset();
      response.put(ResultKeys.CACHE.toString(),session.getCurrentCacheName());
    }
    SysPropertyActions.setThreadContextClassLoader(oldCL);
  }
  return response;
}
