{
  Configuration c=getCache(0,cacheName).getCacheConfiguration();
  if (c.clustering().cacheMode().isReplicated() || c.clustering().cacheMode().isInvalidation()) {
    return (Cache<K,V>)getCache(0,cacheName);
  }
 else {
    if (!c.clustering().cacheMode().isDistributed())     throw new IllegalStateException("This is not a clustered cache!");
    final Address address=getCache(0,cacheName).getAdvancedCache().getDistributionManager().locate(key).get(0);
    for (    Cache<?,?> cache : caches(cacheName)) {
      if (cache.getAdvancedCache().getRpcManager().getTransport().getAddress().equals(address)) {
        return (Cache<K,V>)cache;
      }
    }
    throw new IllegalStateException();
  }
}
