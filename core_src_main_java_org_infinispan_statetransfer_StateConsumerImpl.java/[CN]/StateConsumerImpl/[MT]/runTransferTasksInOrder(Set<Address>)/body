{
  while (true) {
    InboundTransferTask task;
    task=taskQueue.pollFirst();
    if (task == null) {
      isTransferThreadRunning.set(false);
      if (!taskQueue.isEmpty() && isTransferThreadRunning.compareAndSet(false,true)) {
        continue;
      }
 else {
        if (trace)         log.tracef("Stopping state transfer thread");
        break;
      }
    }
    try {
      boolean successful=task.requestSegments();
      if (successful) {
        successful=task.awaitCompletion();
      }
      if (!successful) {
        retryTransferTask(task,excludedSources);
      }
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      return;
    }
catch (    Throwable t) {
      log.failedToRequestSegments(task.getSegments(),cacheName,task.getSource(),t);
    }
  }
}
