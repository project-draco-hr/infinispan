{
  if (keyInvalidationListener != null) {
    keyInvalidationListener.beforeInvalidation(removedSegments,InfinispanCollections.<Integer>emptySet());
  }
  if (removedSegments.isEmpty())   return;
  final ConcurrentHashSet<Object> keysToInvalidate=new ConcurrentHashSet<Object>();
  final ConcurrentHashSet<Object> keysToRemove=new ConcurrentHashSet<Object>();
  dataContainer.executeTask(KeyFilter.ACCEPT_ALL_FILTER,new ParallelIterableMap.KeyValueAction<Object,InternalCacheEntry<Object,Object>>(){
    @Override public void apply(    Object o,    InternalCacheEntry<Object,Object> ice){
      Object key=ice.getKey();
      int keySegment=getSegment(key);
      if (removedSegments.contains(keySegment)) {
        keysToRemove.add(key);
      }
    }
  }
);
  if (!removedSegments.isEmpty()) {
    try {
      KeyFilter filter=new KeyFilter(){
        @Override public boolean accept(        Object key){
          if (dataContainer.containsKey(key))           return false;
          int keySegment=getSegment(key);
          return (removedSegments.contains(keySegment));
        }
      }
;
      persistenceManager.processOnAllStores(filter,new AdvancedCacheLoader.CacheLoaderTask(){
        @Override public void processEntry(        MarshalledEntry marshalledEntry,        AdvancedCacheLoader.TaskContext taskContext) throws InterruptedException {
          keysToRemove.add(marshalledEntry.getKey());
        }
      }
,false,false,PRIVATE);
    }
 catch (    CacheException e) {
      log.failedLoadingKeysFromCacheStore(e);
    }
  }
  log.debugf("Removing %s no longer owned entries for segments %s of cache %s",keysToRemove.size(),removedSegments,cacheName);
  if (!keysToRemove.isEmpty()) {
    try {
      InvalidateCommand invalidateCmd=commandsFactory.buildInvalidateCommand(EnumSet.of(CACHE_MODE_LOCAL,SKIP_LOCKING),keysToRemove.toArray());
      InvocationContext ctx=icf.createNonTxInvocationContext();
      interceptorChain.invoke(ctx,invalidateCmd);
      log.debugf("Removed %d keys, data container now has %d keys",keysToRemove.size(),dataContainer.size());
      if (trace)       log.tracef("Removed keys: %s",keysToRemove);
    }
 catch (    CacheException e) {
      log.failedToInvalidateKeys(e);
    }
  }
}
