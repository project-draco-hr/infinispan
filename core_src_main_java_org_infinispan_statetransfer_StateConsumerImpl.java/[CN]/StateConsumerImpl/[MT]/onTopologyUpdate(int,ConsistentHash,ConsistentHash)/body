{
  log.debugf("Received new CH: %s",writeCh);
  if (trace)   log.tracef("Received new CH: %s",writeCh);
synchronized (this) {
    isTopologyUpdate++;
    this.topologyId=topologyId;
  }
  stateTransferLock.setTopologyId(topologyId);
  try {
    Set<Integer> addedSegments=null;
    if (this.readCh == null) {
      this.readCh=readCh;
      this.writeCh=writeCh;
      if (writeCh.getMembers().size() > 1) {
        if (configuration.clustering().stateTransfer().fetchInMemoryState()) {
          addedSegments=getMySegments(writeCh);
        }
      }
    }
 else {
      this.readCh=readCh;
      this.writeCh=writeCh;
      Set<Integer> oldSegments=getMySegments(readCh);
      Set<Integer> newSegments=getMySegments(writeCh);
      Set<Integer> removedSegments=new HashSet<Integer>(oldSegments);
      removedSegments.removeAll(newSegments);
      discardSegments(removedSegments);
      if (configuration.clustering().stateTransfer().fetchInMemoryState()) {
        addedSegments=new HashSet<Integer>(newSegments);
        addedSegments.removeAll(oldSegments);
        Set<Address> members=new HashSet<Address>(readCh.getMembers());
synchronized (this) {
          for (          Address source : transfersBySource.keySet()) {
            if (!members.contains(source)) {
              List<InboundTransferTask> inboundTransfers=transfersBySource.remove(source);
              if (inboundTransfers != null) {
                for (                InboundTransferTask inboundTransfer : inboundTransfers) {
                  for (                  int segmentId : inboundTransfer.getSegments()) {
                    transfersBySegment.remove(segmentId);
                    addedSegments.add(segmentId);
                  }
                }
              }
            }
          }
        }
      }
    }
    if (addedSegments != null && !addedSegments.isEmpty()) {
      stateTransferLock.commandsExclusiveLock();
      try {
        addTransfers(addedSegments);
      }
  finally {
        stateTransferLock.commandsExclusiveUnlock();
      }
    }
  }
  finally {
synchronized (this) {
      isTopologyUpdate--;
      if (isTopologyUpdate == 0 && !isStateTransferInProgress()) {
        stateTransferManager.notifyEndOfStateTransfer(topologyId);
      }
    }
  }
}
