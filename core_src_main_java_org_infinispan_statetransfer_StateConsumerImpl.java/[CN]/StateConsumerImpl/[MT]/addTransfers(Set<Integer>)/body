{
  log.debugf("Adding state transfer for segments: %s",segments);
  Set<Integer> segmentsToProcess=new HashSet<Integer>(segments);
  Set<Address> blacklistedSources=new HashSet<Address>();
  for (Iterator<Integer> it=segmentsToProcess.iterator(); it.hasNext(); ) {
    Integer segmentId=it.next();
    Address source=pickSourceOwner(segmentId,blacklistedSources);
    if (source == null) {
      it.remove();
    }
  }
synchronized (this) {
    segmentsToProcess.removeAll(transfersBySegment.keySet());
    while (!segmentsToProcess.isEmpty()) {
      Map<Address,Set<Integer>> segmentsBySource=new HashMap<Address,Set<Integer>>();
      for (      int segmentId : segmentsToProcess) {
        if (transfersBySegment.containsKey(segmentId)) {
          throw new IllegalStateException("Cannot have more than one transfer for segment " + segmentId);
        }
        Address source=pickSourceOwner(segmentId,blacklistedSources);
        if (source != null) {
          Set<Integer> segmentsFromSource=segmentsBySource.get(source);
          if (segmentsFromSource == null) {
            segmentsFromSource=new HashSet<Integer>();
            segmentsBySource.put(source,segmentsFromSource);
          }
          segmentsFromSource.add(segmentId);
        }
      }
      Set<Integer> failedSegments=new HashSet<Integer>();
      for (      Address source : segmentsBySource.keySet()) {
        Set<Integer> segmentsFromSource=segmentsBySource.get(source);
        InboundTransferTask inboundTransfer=new InboundTransferTask(segmentsFromSource,source,topologyId,this,rpcManager,commandsFactory,timeout);
        for (        int segmentId : segmentsFromSource) {
          transfersBySegment.put(segmentId,inboundTransfer);
        }
        List<InboundTransferTask> inboundTransfers=transfersBySource.get(inboundTransfer.getSource());
        if (inboundTransfers == null) {
          inboundTransfers=new ArrayList<InboundTransferTask>();
          transfersBySource.put(inboundTransfer.getSource(),inboundTransfers);
        }
        inboundTransfers.add(inboundTransfer);
        if (inboundTransfer.requestTransactions()) {
          if (!inboundTransfer.requestSegments()) {
            log.errorf("Failed to request segments %s from %s",segmentsFromSource,source);
          }
        }
 else {
          log.errorf("Failed to retrieve transactions for segments %s from %s",segmentsFromSource,source);
          log.tracef("Adding members %s to black list",source);
          failedSegments.addAll(segmentsFromSource);
          blacklistedSources.add(source);
          removeTransfer(inboundTransfer);
        }
      }
      segmentsToProcess=failedSegments;
    }
  }
}
