{
  GlobalConfigurationBuilder gcb=new GlobalConfigurationBuilder().nonClusteredDefault();
  gcb.globalJmxStatistics().enable().allowDuplicateDomains(true).jmxDomain(JMX_DOMAIN).mBeanServerLookup(new PerThreadMBeanServerLookup());
  ConfigurationBuilder builder=new ConfigurationBuilder();
  builder.dataContainer().keyEquivalence(ByteArrayEquivalence.INSTANCE).valueEquivalence(ByteArrayEquivalence.INSTANCE).indexing().index(Index.ALL).addProperty("default.directory_provider","ram").addProperty("lucene_version","LUCENE_CURRENT");
  cacheManager=TestCacheManagerFactory.createCacheManager(gcb,builder,true);
  cacheManager.defineConfiguration(TEST_CACHE_NAME,builder.build());
  cache=cacheManager.getCache(TEST_CACHE_NAME);
  hotRodServer=TestHelper.startHotRodServer(cacheManager);
  org.infinispan.client.hotrod.configuration.ConfigurationBuilder clientBuilder=new org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
  clientBuilder.addServer().host("127.0.0.1").port(hotRodServer.getPort());
  clientBuilder.marshaller(new ProtoStreamMarshaller());
  remoteCacheManager=new RemoteCacheManager(clientBuilder.build());
  remoteCache=remoteCacheManager.getCache(TEST_CACHE_NAME);
  mBeanServer=PerThreadMBeanServerLookup.getThreadMBeanServer();
  ProtobufMetadataManagerMBean protobufMetadataManagerMBean=JMX.newMBeanProxy(mBeanServer,getProtobufMetadataManagerObjectName(),ProtobufMetadataManagerMBean.class);
  protobufMetadataManagerMBean.registerProtofiles(new String[]{"sample_bank_account/bank.proto","infinispan/indexing.proto","google/protobuf/descriptor.proto"},new String[]{read("/sample_bank_account/bank.proto"),read("/infinispan/indexing.proto"),read("/google/protobuf/descriptor.proto")});
  MarshallerRegistration.registerMarshallers(ProtoStreamMarshaller.getSerializationContext(remoteCacheManager));
  return cacheManager;
}
