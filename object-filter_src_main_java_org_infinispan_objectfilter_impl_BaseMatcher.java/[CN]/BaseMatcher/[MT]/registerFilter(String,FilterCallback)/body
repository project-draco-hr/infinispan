{
  FilterParsingResult<TypeMetadata> parsingResult=parse(jpaQuery);
  BooleanExpr normalizedFilter=booleanFilterNormalizer.normalize(parsingResult.getQuery());
  write.lock();
  try {
    FilterRegistry<TypeMetadata,AttributeMetadata,AttributeId> filterRegistry=filtersByTypeName.get(parsingResult.getTargetEntityName());
    if (filterRegistry == null) {
      filterRegistry=createFilterRegistryForType(parsingResult.getTargetEntityMetadata());
      filtersByTypeName.put(parsingResult.getTargetEntityName(),filterRegistry);
      filtersByType.put(filterRegistry.getMetadataAdapter().getTypeMetadata(),filterRegistry);
    }
    return filterRegistry.addFilter(normalizedFilter,parsingResult.getProjections(),parsingResult.getSortFields(),callback);
  }
  finally {
    write.unlock();
  }
}
