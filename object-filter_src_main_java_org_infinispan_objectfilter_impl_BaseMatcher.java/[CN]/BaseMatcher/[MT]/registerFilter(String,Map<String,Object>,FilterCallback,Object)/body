{
  FilterParsingResult<TypeMetadata> parsingResult=parse(jpaQuery,namedParameters);
  disallowGroupingAndAggregations(parsingResult);
  write.lock();
  try {
    FilterRegistry<TypeMetadata,AttributeMetadata,AttributeId> filterRegistry=filtersByTypeName.get(parsingResult.getTargetEntityName());
    if (filterRegistry == null) {
      filterRegistry=new FilterRegistry<>(createMetadataAdapter(parsingResult.getTargetEntityMetadata()),true);
      filtersByTypeName.put(parsingResult.getTargetEntityName(),filterRegistry);
      filtersByType.put(filterRegistry.getMetadataAdapter().getTypeMetadata(),filterRegistry);
    }
    return filterRegistry.addFilter(jpaQuery,namedParameters,parsingResult.getWhereClause(),parsingResult.getProjections(),parsingResult.getProjectedTypes(),parsingResult.getSortFields(),callback,eventType);
  }
  finally {
    write.unlock();
  }
}
