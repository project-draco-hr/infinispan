{
  InputStream schemaInputStream=InfinispanConfiguration.findSchemaInputStream();
  try {
    ConfigurationBuilderHolder holder=new Parser(Thread.currentThread().getContextClassLoader()).parse(configurationStream);
    globalConfiguration=new LegacyGlobalConfigurationAdaptor().adapt(holder.getGlobalConfigurationBuilder().build());
    globalConfiguration.accept(configurationValidator);
    defaultConfiguration=new LegacyConfigurationAdaptor().adapt(holder.getDefaultConfigurationBuilder().build());
    for (    ConfigurationBuilder b : holder.getConfigurationBuilders()) {
      org.infinispan.configuration.cache.Configuration c=b.build();
      Configuration legacy=new LegacyConfigurationAdaptor().adapt(c);
      configurationOverrides.put(c.name(),legacy);
    }
    globalComponentRegistry=new GlobalComponentRegistry(globalConfiguration,this,caches.keySet());
    cacheCreateLock=new ReentrantLock();
  }
 catch (  ConfigurationException ce) {
    throw ce;
  }
catch (  RuntimeException re) {
    throw new ConfigurationException(re);
  }
 finally {
    Util.close(schemaInputStream);
  }
  if (start)   start();
}
