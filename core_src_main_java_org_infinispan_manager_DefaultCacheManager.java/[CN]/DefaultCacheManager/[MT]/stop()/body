{
  authzHelper.checkPermission(AuthorizationPermission.LIFECYCLE);
  if (!stopping) {
synchronized (this) {
      if (!stopping) {
        log.debugf("Stopping cache manager %s on %s",globalConfiguration.transport().clusterName(),getAddress());
        stopping=true;
        Set<String> cachesToStop=new LinkedHashSet<>();
        boolean defaultCacheHasDependency=false;
        try {
          List<String> ordered=cacheDependencyGraph.topologicalSort();
          defaultCacheHasDependency=ordered.contains(DEFAULT_CACHE_NAME);
          cachesToStop.addAll(ordered);
        }
 catch (        CyclicDependencyException e) {
          log.stopOrderIgnored();
        }
        cachesToStop.addAll(caches.keySet());
        Cache<?,?> defaultCache=null;
        for (        String cacheName : cachesToStop) {
          if (cacheName.equals(ClusterRegistryImpl.GLOBAL_REGISTRY_CACHE_NAME)) {
          }
 else           if (cacheName.equals(DEFAULT_CACHE_NAME) && !defaultCacheHasDependency) {
            defaultCache=this.caches.get(cacheName).cache;
          }
 else {
            terminate(this.caches.get(cacheName).cache);
          }
        }
        terminate(defaultCache);
        globalComponentRegistry.getComponent(CacheManagerJmxRegistration.class).stop();
        globalComponentRegistry.stop();
      }
 else {
        log.trace("Ignore call to stop as the cache manager is stopping");
      }
    }
  }
 else {
    log.trace("Ignore call to stop as the cache manager is stopping");
  }
}
