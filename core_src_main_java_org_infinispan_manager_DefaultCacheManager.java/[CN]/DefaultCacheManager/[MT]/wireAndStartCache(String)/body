{
  CacheWrapper createdCacheWrapper=null;
  try {
synchronized (caches) {
      CacheWrapper existingCacheWrapper=caches.get(cacheName);
      if (existingCacheWrapper != null) {
        return null;
      }
      createdCacheWrapper=new CacheWrapper();
      if (caches.put(cacheName,createdCacheWrapper) != null) {
        throw new IllegalStateException("attempt to initialize the cache twice");
      }
    }
    globalComponentRegistry.start();
    Configuration c=getConfiguration(cacheName);
    log.tracef("About to wire and start cache %s",cacheName);
    Cache<K,V> cache=new InternalCacheFactory<K,V>().createCache(c,globalComponentRegistry,cacheName);
    createdCacheWrapper.setCache(cache);
    cache.start();
    return cache;
  }
  finally {
    if (createdCacheWrapper != null) {
      log.tracef("Closing latch for cache %s",cacheName);
      createdCacheWrapper.latch.countDown();
    }
  }
}
