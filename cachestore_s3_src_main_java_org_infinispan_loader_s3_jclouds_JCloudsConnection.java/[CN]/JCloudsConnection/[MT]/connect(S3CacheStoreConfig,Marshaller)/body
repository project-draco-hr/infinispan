{
  InputStream propertiesIS;
  try {
    propertiesIS=JCloudsConnection.class.getResourceAsStream("/jclouds.properties");
    Properties properties=new Properties();
    properties.load(propertiesIS);
    if (!config.isSecure()) {
      properties.put(S3Constants.PROPERTY_HTTP_PORT,"80");
      properties.put(S3Constants.PROPERTY_HTTP_SECURE,"false");
    }
    if (!properties.containsKey(S3Constants.PROPERTY_AWS_ACCESSKEYID))     properties.put(S3Constants.PROPERTY_AWS_ACCESSKEYID,config.getAwsAccessKey());
    if (!properties.containsKey(S3Constants.PROPERTY_AWS_SECRETACCESSKEY))     properties.put(S3Constants.PROPERTY_AWS_SECRETACCESSKEY,config.getAwsSecretKey());
    if (!properties.containsKey(S3Constants.PROPERTY_POOL_MAX_CONNECTIONS))     properties.put(S3Constants.PROPERTY_POOL_MAX_CONNECTIONS,config.getMaxConnections());
    this.context=S3ContextFactory.createS3Context(properties,new S3HttpNioConnectionPoolClientModule());
    this.s3Service=context.getConnection();
    if (this.s3Service == null) {
      throw new S3ConnectionException("Could not connect");
    }
  }
 catch (  Exception ex) {
    throw convertToS3ConnectionException("Exception connecting to s3",ex);
  }
  this.marshaller=m;
}
