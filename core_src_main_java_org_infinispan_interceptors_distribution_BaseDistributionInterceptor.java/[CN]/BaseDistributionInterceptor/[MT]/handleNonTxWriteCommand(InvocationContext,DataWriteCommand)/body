{
  if (ctx.isInTxScope()) {
    throw new CacheException("Attempted execution of non-transactional write command in a transactional invocation context");
  }
  RecipientGenerator recipientGenerator=new SingleKeyRecipientGenerator(command.getKey());
  remoteGetBeforeWrite(ctx,command,recipientGenerator);
  if (isLocalModeForced(command)) {
    return invokeNextInterceptor(ctx,command);
  }
  boolean isSync=isSynchronous(command);
  if (!ctx.isOriginLocal()) {
    Object returnValue=invokeNextInterceptor(ctx,command);
    Address primaryOwner=cdl.getPrimaryOwner(command.getKey());
    if (primaryOwner.equals(rpcManager.getAddress())) {
      rpcManager.invokeRemotely(recipientGenerator.generateRecipients(),command,rpcManager.getDefaultRpcOptions(isSync));
    }
    return returnValue;
  }
 else {
    Address primaryOwner=cdl.getPrimaryOwner(command.getKey());
    if (primaryOwner.equals(rpcManager.getAddress())) {
      List<Address> recipients=recipientGenerator.generateRecipients();
      log.tracef("I'm the primary owner, sending the command to all (%s) the recipients in order to be applied.",recipients);
      Object result=invokeNextInterceptor(ctx,command);
      boolean isSingleOwnerAndLocal=cacheConfiguration.clustering().hash().numOwners() == 1 && recipients != null && recipients.size() == 1 && recipients.get(0).equals(rpcManager.getTransport().getAddress());
      if (!isSingleOwnerAndLocal) {
        rpcManager.invokeRemotely(recipients,command,rpcManager.getDefaultRpcOptions(isSync));
      }
      return result;
    }
 else {
      log.tracef("I'm not the primary owner, so sending the command to the primary owner(%s) in order to be forwarded",primaryOwner);
      Object localResult=invokeNextInterceptor(ctx,command);
      Map<Address,Response> addressResponseMap=rpcManager.invokeRemotely(Collections.singletonList(primaryOwner),command,rpcManager.getDefaultRpcOptions(isSync));
      if (!isSync)       return localResult;
      return getResponseFromPrimaryOwner(primaryOwner,addressResponseMap);
    }
  }
}
