{
  ConfigurationBuilder builder=getDefaultClusteredCacheConfig(CacheMode.DIST_SYNC,true);
  withCacheManager(new CacheManagerCallable(TestCacheManagerFactory.createClusteredCacheManager(builder)){
    @Override public void call(){
      try {
        Cache cache=cm.getCache();
        cache.stop();
        MapReduceTask<String,String,String,Integer> task=createMapReduceTask(cache);
      }
 catch (      IllegalStateException ex) {
        assertNotNull(ex.getMessage());
        assertTrue(ex.getMessage().contains("Cache is in an invalid state:"));
        throw ex;
      }
    }
  }
);
}
