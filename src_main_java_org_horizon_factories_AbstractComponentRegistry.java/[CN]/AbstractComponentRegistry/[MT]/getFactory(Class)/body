{
  Map<Class,Class<? extends AbstractComponentFactory>> defaultFactoryMap=getDefaultFactoryMap();
  Class<? extends AbstractComponentFactory> cfClass=defaultFactoryMap.get(componentClass);
  if (cfClass == null)   throw new ConfigurationException("No registered default factory for component " + componentClass + " found! Debug stack: "+ debugStack);
  AbstractComponentFactory cf=getComponent(cfClass);
  if (cf == null) {
    cf=instantiateFactory(cfClass);
    if (cf == null)     throw new ConfigurationException("Unable to locate component factory for component " + componentClass + "  Debug stack: "+ debugStack);
    registerComponent(cf,cfClass);
  }
  Component c=lookupComponent(cfClass,cfClass.getName());
  if (c.instance != cf)   throw new ConfigurationException("Component factory " + cfClass + " incorrectly registered! Debug stack: "+ debugStack);
  return cf;
}
