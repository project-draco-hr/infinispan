{
  log.tracef("Waiting for all the members of the cluster to confirm joining for view %d, confirmed members %s",viewId,joinConfirmations);
  lock.lock();
  try {
    if (viewId == lastViewId && joinConfirmations.size() < membersCount) {
      clusterConfirmedJoin.await(timeout,TimeUnit.MILLISECONDS);
    }
    if (joinConfirmations.size() == membersCount) {
      log.tracef("Join confirmed by all cluster members");
      return true;
    }
    if (viewId < lastViewId) {
      log.tracef("Received new view %d while waiting for join confirmations for view %d",lastViewId,viewId);
      return false;
    }
    log.stateTransferTimeoutWaitingForJoinConfirmations(viewId,joinConfirmations);
    throw new TimeoutException("Timed out waiting for all cluster members to confirm joining");
  }
  finally {
    lock.unlock();
  }
}
