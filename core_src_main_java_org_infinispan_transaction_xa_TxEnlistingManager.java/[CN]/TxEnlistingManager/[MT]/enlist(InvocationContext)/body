{
  Transaction transaction=tm.getTransaction();
  if (transaction == null)   throw new IllegalStateException("This should only be called in an tx scope");
  if (!isValid(transaction))   throw new IllegalStateException("Transaction " + transaction + " is not in a valid state to be invoking cache operations on.");
  TransactionXaAdapter current=tx2XaCacheMapping.get(transaction);
  if (current == null) {
    GlobalTransaction tx=rpcManager == null ? new GlobalTransaction(false) : new GlobalTransaction(rpcManager.getLocalAddress(),false);
    current=new TransactionXaAdapter(tx,icc,invoker,commandsFactory,configuration,this,transaction);
    tx2XaCacheMapping.put(transaction,current);
    transaction.enlistResource(current);
    notifier.notifyTransactionRegistered(tx,ctx);
  }
  return current;
}
