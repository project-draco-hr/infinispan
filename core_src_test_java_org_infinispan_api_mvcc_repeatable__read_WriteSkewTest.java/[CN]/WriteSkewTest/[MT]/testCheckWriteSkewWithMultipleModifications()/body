{
  setCacheWithWriteSkewCheck();
  postStart();
  final AtomicInteger successes=new AtomicInteger();
  final AtomicInteger rollbacks=new AtomicInteger();
  final CountDownLatch latch1=new CountDownLatch(1);
  final CountDownLatch latch2=new CountDownLatch(1);
  final CountDownLatch latch3=new CountDownLatch(1);
  Thread t1=new Thread(new Runnable(){
    public void run(){
      try {
        latch1.await();
        tm.begin();
        try {
          try {
            cache.get("k1");
            cache.put("k1","v1");
            cache.put("k2","thread 1");
          }
  finally {
            latch2.countDown();
          }
          latch3.await();
          tm.commit();
          successes.incrementAndGet();
        }
 catch (        Exception e) {
          if (e instanceof RollbackException) {
            rollbacks.incrementAndGet();
          }
          if (tm.getTransaction() != null) {
            try {
              tm.rollback();
            }
 catch (            SystemException e1) {
              log.error("Failed to rollback",e1);
            }
          }
          throw e;
        }
      }
 catch (      Exception ex) {
        ex.printStackTrace();
      }
    }
  }
,"WriteSkewTest.Thread-1");
  Thread t2=new Thread(new Runnable(){
    public void run(){
      try {
        latch2.await();
        tm.begin();
        try {
          try {
            cache.get("k1");
            cache.put("k1","v2");
            cache.put("k3","thread 2");
            tm.commit();
            successes.incrementAndGet();
          }
  finally {
            latch3.countDown();
          }
        }
 catch (        Exception e) {
          if (e instanceof RollbackException) {
            rollbacks.incrementAndGet();
          }
          if (tm.getTransaction() != null) {
            try {
              tm.rollback();
            }
 catch (            SystemException e1) {
              log.error("Failed to rollback",e1);
            }
          }
          throw e;
        }
      }
 catch (      Exception ex) {
        ex.printStackTrace();
      }
    }
  }
,"WriteSkewTest.Thread-2");
  t1.start();
  t2.start();
  latch1.countDown();
  t1.join();
  t2.join();
  log.trace("successes= " + successes.get());
  log.trace("rollbacks= " + rollbacks.get());
  Assert.assertTrue(cache.containsKey("k1"));
  Assert.assertEquals("v2",cache.get("k1"));
  Assert.assertEquals(1,successes.get());
  Assert.assertEquals(1,rollbacks.get());
}
