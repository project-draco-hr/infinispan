{
  Throwable t=e.getCause();
  log.error("Unexpected exception",t);
  Channel ch=ctx.getChannel();
  if (t instanceof UnknownCommandException) {
    ch.write(wrappedBuffer(wrappedBuffer(Reply.ERROR.bytes()),wrappedBuffer(CRLF)));
  }
 else   if (t instanceof IOException) {
    StringBuilder sb=new StringBuilder();
    sb.append(Reply.CLIENT_ERROR).append(' ').append(t);
    ch.write(wrappedBuffer(wrappedBuffer(sb.toString().getBytes()),wrappedBuffer(CRLF)));
  }
 else {
    StringBuilder sb=new StringBuilder();
    sb.append(Reply.SERVER_ERROR).append(' ').append(t);
    ch.write(wrappedBuffer(wrappedBuffer(sb.toString().getBytes()),wrappedBuffer(CRLF)));
  }
}
