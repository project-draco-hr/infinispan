{
  EntityManager em=emf.createEntityManager();
  Object o=entry.getValue();
  try {
    if (!config.getEntityClass().isAssignableFrom(o.getClass())) {
      throw new JpaCacheLoaderException("This cache is configured with JPA CacheStore to only store values of type " + config.getEntityClassName());
    }
 else {
      EntityTransaction txn=em.getTransaction();
      Object id=emf.getPersistenceUnitUtil().getIdentifier(o);
      if (!entry.getKey().equals(id)) {
        throw new JpaCacheLoaderException("Entity id value must equal to key of cache entry: " + "key = [" + entry.getKey() + "], id = ["+ id+ "]");
      }
      try {
        txn.begin();
        em.merge(o);
        txn.commit();
      }
 catch (      Exception e) {
        if (txn != null && txn.isActive())         txn.rollback();
        throw new CacheLoaderException("Exception caught in store()",e);
      }
    }
  }
  finally {
    em.close();
  }
}
