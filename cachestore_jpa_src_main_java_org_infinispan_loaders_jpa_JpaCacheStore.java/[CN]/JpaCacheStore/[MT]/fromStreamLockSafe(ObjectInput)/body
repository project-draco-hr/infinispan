{
  long batchSize=0;
  EntityManager em=emf.createEntityManager();
  EntityTransaction txn=em.getTransaction();
  try {
    Object o=marshaller.objectFromObjectStream(ois);
    txn.begin();
    while (o != null) {
      if (!o.getClass().isAnnotationPresent(Entity.class))       break;
      em.merge(o);
      batchSize++;
      if (batchSize >= config.getBatchSize()) {
        em.flush();
        em.clear();
        batchSize=0;
      }
      o=marshaller.objectFromObjectStream(ois);
    }
    txn.commit();
  }
 catch (  InterruptedException e) {
    if (txn != null && txn.isActive())     txn.rollback();
    Thread.currentThread().interrupt();
  }
catch (  Exception e) {
    if (txn != null && txn.isActive())     txn.rollback();
    throw new CacheLoaderException(e);
  }
 finally {
    em.close();
  }
}
