{
  cm1=TestCacheManagerFactory.createLocalCacheManager(false);
  cm1.getCache();
  CacheManagerNotifier mockNotifier=createMock(CacheManagerNotifier.class);
  CacheManagerNotifier origNotifier=TestingUtil.replaceComponent(cm1,CacheManagerNotifier.class,mockNotifier,true);
  try {
    cm1.defineConfiguration("testCache",new Configuration());
    mockNotifier.notifyCacheStarted("testCache");
    mockNotifier.addListener(isA(StaleTransactionCleanupService.class));
    mockNotifier.addListener(isA(TransactionTable.class));
    replay(mockNotifier);
    Cache testCache=cm1.getCache("testCache");
    verify(mockNotifier);
    reset(mockNotifier);
    mockNotifier.removeListener(isA(StaleTransactionCleanupService.class));
    mockNotifier.removeListener(isA(TransactionTable.class));
    mockNotifier.notifyCacheStopped("testCache");
    replay(mockNotifier);
    testCache.stop();
    verify(mockNotifier);
  }
  finally {
    TestingUtil.replaceComponent(cm1,CacheManagerNotifier.class,origNotifier,true);
  }
}
