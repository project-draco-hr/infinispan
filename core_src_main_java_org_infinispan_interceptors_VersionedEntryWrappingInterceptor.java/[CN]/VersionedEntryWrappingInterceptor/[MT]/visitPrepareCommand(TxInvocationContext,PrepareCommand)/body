{
  VersionedPrepareCommand versionedPrepareCommand=(VersionedPrepareCommand)command;
  if (ctx.isOriginLocal()) {
    versionedPrepareCommand.setVersionsSeen(ctx.getCacheTransaction().getVersionsRead());
  }
  wrapEntriesForPrepare(ctx,command);
  EntryVersionsMap newVersionData=null;
  if (ctx.isOriginLocal() && !ctx.getCacheTransaction().isFromStateTransfer()) {
    newVersionData=cdl.createNewVersionsAndCheckForWriteSkews(versionGenerator,ctx,versionedPrepareCommand);
  }
  Object retval=invokeNextInterceptor(ctx,command);
  if (!ctx.isOriginLocal()) {
    newVersionData=cdl.createNewVersionsAndCheckForWriteSkews(versionGenerator,ctx,versionedPrepareCommand);
  }
  if (command.isOnePhaseCommit()) {
    ctx.getCacheTransaction().setUpdatedEntryVersions(versionedPrepareCommand.getVersionsSeen());
  }
  if (newVersionData != null) {
    retval=newVersionData;
  }
  if (command.isOnePhaseCommit()) {
    commitContextEntries(ctx,null,null);
  }
  return retval;
}
