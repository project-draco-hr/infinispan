{
  List<WriteCommand> c;
  while (tlog.shouldDrainWithoutLock()) {
    c=tlog.drain();
    if (trace)     log.tracef("Draining %s entries from transaction log",c.size());
    applyRemoteTxLog(c);
  }
  boolean unlock=acquireDistSyncLock();
  try {
    this.enteredFinalJoinPhase=true;
    c=tlog.drainAndLock(null);
    if (trace)     log.tracef("Locked and draining %s entries from transaction log",c.size());
    applyRemoteTxLog(c);
    Collection<PrepareCommand> pendingPrepares=tlog.getPendingPrepares();
    if (trace)     log.tracef("Applying %s pending prepares",pendingPrepares.size());
    for (    PrepareCommand pc : pendingPrepares) {
      cf.initializeReplicableCommand(pc,true);
      try {
        pc.perform(null);
      }
 catch (      Throwable throwable) {
        log.unableToApplyPrepare(pc,throwable);
      }
    }
  }
  finally {
    tlog.unlockAndDisable(null);
    if (unlock)     rpcManager.getTransport().getDistributedSync().releaseProcessingLock(true);
  }
}
