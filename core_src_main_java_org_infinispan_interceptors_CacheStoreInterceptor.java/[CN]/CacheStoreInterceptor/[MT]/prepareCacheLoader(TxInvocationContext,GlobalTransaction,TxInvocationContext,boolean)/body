{
  if (transactionContext == null) {
    throw new Exception("transactionContext for transaction " + gtx + " not found in transaction table");
  }
  List<WriteCommand> modifications=transactionContext.getModifications();
  if (!transactionContext.hasModifications()) {
    if (getLog().isTraceEnabled())     getLog().trace("Transaction has not logged any modifications!");
    return;
  }
  if (getLog().isTraceEnabled())   getLog().tracef("Cache loader modification list: %s",modifications);
  StoreModificationsBuilder modsBuilder=new StoreModificationsBuilder(getStatisticsEnabled(),modifications.size());
  for (  WriteCommand cacheCommand : modifications)   cacheCommand.acceptVisitor(ctx,modsBuilder);
  int numMods=modsBuilder.modifications.size();
  if (getLog().isTraceEnabled())   getLog().tracef("Converted method calls to cache loader modifications.  List size: %s",numMods);
  if (numMods > 0) {
    GlobalTransaction tx=transactionContext.getGlobalTransaction();
    store.prepare(modsBuilder.modifications,tx,onePhase);
    boolean shouldCountStores=getStatisticsEnabled() && modsBuilder.putCount > 0;
    if (!onePhase) {
      preparingTxs.put(tx,modsBuilder.affectedKeys);
      if (shouldCountStores) {
        txStores.put(tx,modsBuilder.putCount);
      }
    }
 else     if (shouldCountStores) {
      cacheStores.getAndAdd(modsBuilder.putCount);
    }
  }
}
