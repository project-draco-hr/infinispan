{
  try {
    JAXBContext jc=JAXBContext.newInstance(InfinispanConfiguration.class);
    Unmarshaller u=jc.createUnmarshaller();
    if (schema != null) {
      SchemaFactory factory=SchemaFactory.newInstance("http://www.w3.org/2001/XMLSchema");
      u.setSchema(factory.newSchema(new StreamSource(schema)));
      u.setEventHandler(new ValidationEventHandler(){
        @Override public boolean handleEvent(        ValidationEvent event){
          int severity=event.getSeverity();
          return (severity != ValidationEvent.FATAL_ERROR && severity != ValidationEvent.ERROR);
        }
      }
);
    }
    InputSource source=null;
    if (skipTokenReplacement()) {
      source=new InputSource(config);
    }
 else {
      source=replaceProperties(config);
    }
    DocumentBuilderFactory dbf=DocumentBuilderFactory.newInstance();
    dbf.setNamespaceAware(true);
    DocumentBuilder db=dbf.newDocumentBuilder();
    Document document=db.parse(source);
    InfinispanConfiguration ic=(InfinispanConfiguration)u.unmarshal(document);
    GlobalConfiguration gconf=ic.parseGlobalConfiguration();
    gconf.setDefaultConfiguration(ic.parseDefaultConfiguration());
    if (cbv != null) {
      ic.accept(cbv);
    }
    ic.accept(new ModuleConfigurationResolverVisitor(document));
    return ic;
  }
 catch (  ConfigurationException cex) {
    throw cex;
  }
catch (  NullPointerException npe) {
    throw npe;
  }
catch (  Exception e) {
    IOException ioe=new IOException(e.getLocalizedMessage());
    ioe.initCause(e);
    throw ioe;
  }
}
