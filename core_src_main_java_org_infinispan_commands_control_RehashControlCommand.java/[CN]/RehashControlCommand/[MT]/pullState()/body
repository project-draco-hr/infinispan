{
  Address self=transport.getAddress();
  ConsistentHash oldCH=distributionManager.getConsistentHash();
  int numCopies=configuration.getNumOwners();
  Map<Object,InternalCacheValue> state=new HashMap<Object,InternalCacheValue>();
  for (  InternalCacheEntry ice : dataContainer) {
    Object k=ice.getKey();
    if (shouldAddToMap(k,oldCH,numCopies,self))     state.put(k,ice.toInternalCacheValue());
  }
  CacheStore cacheStore=distributionManager.getCacheStoreForRehashing();
  if (cacheStore != null) {
    for (    Object k : cacheStore.loadAllKeys(new ReadOnlyDataContainerBackedKeySet(dataContainer))) {
      if (!state.containsKey(k) && shouldAddToMap(k,oldCH,numCopies,self)) {
        InternalCacheValue v=loadValue(cacheStore,k);
        if (v != null)         state.put(k,v);
      }
    }
  }
  return state;
}
