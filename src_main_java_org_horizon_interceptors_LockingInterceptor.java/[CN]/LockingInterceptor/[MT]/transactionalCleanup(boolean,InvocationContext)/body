{
  if (ctx.getTransactionContext() != null) {
    if (ctx.isContainsModifications() || ctx.isContainsLocks()) {
      if (trace)       log.trace("Performing cleanup.  Contains mods? {0} Contains locks? {1}",ctx.isContainsModifications(),ctx.isContainsLocks());
      cleanupLocks(ctx,ctx.getGlobalTransaction(),commit);
    }
 else {
      if (trace)       log.trace("At transaction boundary (" + (commit ? "commit" : "rollback") + "), and we have no locks in context!");
    }
  }
 else {
    throw new IllegalStateException("Attempting to do a commit or rollback but there is no transactional context in scope. " + ctx);
  }
}
