{
  long lockTimeout=getLockAcquisitionTimeout(ctx);
  if (trace)   log.trace("Attempting to lock %s with acquisition timeout of %s millis",key,lockTimeout);
  if (ctx.isInTxScope()) {
    if (trace)     log.trace("Using early dead lock detection");
    final long start=System.currentTimeMillis();
    DldGlobalTransaction thisTx=(DldGlobalTransaction)ctx.getLockOwner();
    thisTx.setLockIntention(key);
    if (trace)     log.trace("Setting lock intention to: " + key);
    while (System.currentTimeMillis() < (start + lockTimeout)) {
      if (lockContainer.acquireLock(key,spinDuration,MILLISECONDS) != null) {
        thisTx.setLockIntention(null);
        if (trace)         log.trace("successfully acquired lock on " + key + ", returning ...");
        return true;
      }
 else {
        Object owner=getOwner(key);
        if (!(owner instanceof DldGlobalTransaction)) {
          if (trace)           log.trace("Not running DLD as lock owner( " + owner + ") is not a transaction");
          cannotRunDld.incrementAndGet();
          continue;
        }
        DldGlobalTransaction lockOwnerTx=(DldGlobalTransaction)owner;
        if (isDeadlockAndIAmLoosing(lockOwnerTx,thisTx,key)) {
          updateStats(thisTx);
          String message="Deadlock found and we " + thisTx + " shall not continue. Other tx is "+ lockOwnerTx;
          if (trace)           log.trace(message);
          throw new DeadlockDetectedException(message);
        }
      }
    }
  }
 else {
    if (lockContainer.acquireLock(key,lockTimeout,MILLISECONDS) != null) {
      return true;
    }
  }
  return false;
}
