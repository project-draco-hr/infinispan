{
  try {
    currentTransaction.beginTransaction(null);
    for (    Database db : new Database[]{cacheDb,expiryDb}) {
      long recordCount=db.count();
      oos.writeLong(recordCount);
      if (trace)       log.trace("writing {0} records to stream",recordCount);
      Cursor cursor=null;
      try {
        cursor=db.openCursor(currentTransaction.getTransaction(),null);
        DatabaseEntry key=new DatabaseEntry();
        DatabaseEntry data=new DatabaseEntry();
        int recordsWritten=0;
        while (cursor.getNext(key,data,null) == OperationStatus.SUCCESS) {
          oos.writeObject(key.getData());
          oos.writeObject(data.getData());
          recordsWritten++;
        }
        if (trace)         log.trace("wrote {0} records to stream",recordsWritten);
        if (recordsWritten != recordCount)         log.warn("expected to write {0} records, but wrote {1}",recordCount,recordsWritten);
      }
  finally {
        if (cursor != null)         cursor.close();
      }
    }
    completeCurrentTransaction(true);
  }
 catch (  Exception caught) {
    completeCurrentTransaction(false);
    throw convertToCacheLoaderException("Problems writing to stream",caught);
  }
}
