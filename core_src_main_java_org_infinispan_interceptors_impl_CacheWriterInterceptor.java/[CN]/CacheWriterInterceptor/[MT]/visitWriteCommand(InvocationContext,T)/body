{
  Object retval=ctx.forkInvocationSync(command);
  if (!isStoreEnabled(command) || ctx.isInTxScope() || !command.isSuccessful())   return ctx.shortCircuit(retval);
  if (!isProperWriter(ctx,command,command.getKey()))   return ctx.shortCircuit(retval);
  Param<PersistenceMode> persistMode=command.getParams().get(PersistenceMode.ID);
switch (persistMode.get()) {
case PERSIST:
    Object key=command.getKey();
  CacheEntry entry=ctx.lookupEntry(key);
if (entry != null) {
  if (entry.isRemoved()) {
    boolean resp=persistenceManager.deleteFromAllStores(key,BOTH);
    if (trace)     getLog().tracef("Removed entry under key %s and got response %s from CacheStore",key,resp);
  }
 else   if (entry.isChanged()) {
    storeEntry(ctx,key,command);
  }
  break;
}
case SKIP:
log.trace("Skipping cache store since persistence mode parameter is SKIP");
}
return ctx.shortCircuit(retval);
}
