{
  Map<Object,Modification> keyMods=new HashMap<Object,Modification>();
  List<Modification> coalesced=new ArrayList<Modification>();
  for (  Modification mod : mods) {
switch (mod.getType()) {
case STORE:
      keyMods.put(((Store)mod).getStoredEntry().getKey(),mod);
    break;
case CLEAR:
  keyMods.clear();
coalesced.add(mod);
break;
case REMOVE:
if (!coalesced.isEmpty() && keyMods.containsKey(((Remove)mod).getKey())) {
keyMods.remove(((Remove)mod).getKey());
}
 else if (coalesced.isEmpty()) {
keyMods.put(((Remove)mod).getKey(),mod);
}
break;
default :
throw new IllegalArgumentException("Unknown modification type " + mod.getType());
}
}
coalesced.addAll(keyMods.values());
return coalesced;
}
