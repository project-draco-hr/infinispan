{
  BatchDetails bd=batchDetailsTl.get();
  try {
    if (transactionManager.getTransaction() == null && bd.tx == null) {
      transactionManager.begin();
      bd.nestedInvocationCount=1;
      bd.suspendTxAfterInvocation=!autoBatch;
      if (autoBatch)       bd.tx=transactionManager.getTransaction();
 else       bd.tx=transactionManager.suspend();
      return true;
    }
 else {
      bd.nestedInvocationCount++;
      return false;
    }
  }
 catch (  Exception e) {
    throw new CacheException("Unable to start batch",e);
  }
 finally {
    batchDetailsTl.set(bd);
  }
}
