{
  boolean done=false;
  Object lockValue=cache.withFlags(Flag.SKIP_LOCKING,Flag.SKIP_CACHE_STORE).get(readLockKey);
  while (done == false) {
    if (lockValue != null) {
      int refCount=(Integer)lockValue;
      if (refCount == 0) {
        throw new FileNotFoundException("segment file was deleted");
      }
      Integer newValue=Integer.valueOf(refCount + 1);
      done=cache.withFlags(Flag.SKIP_CACHE_STORE).replace(readLockKey,refCount,newValue);
      if (!done) {
        lockValue=cache.withFlags(Flag.SKIP_LOCKING,Flag.SKIP_CACHE_STORE).get(readLockKey);
      }
    }
 else {
      lockValue=cache.withFlags(Flag.SKIP_CACHE_STORE).putIfAbsent(readLockKey,Integer.valueOf(2));
      done=(null == lockValue);
    }
  }
}
