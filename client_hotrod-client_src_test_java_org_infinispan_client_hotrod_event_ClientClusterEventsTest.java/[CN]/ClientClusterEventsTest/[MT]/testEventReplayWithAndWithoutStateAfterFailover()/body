{
  org.infinispan.client.hotrod.configuration.ConfigurationBuilder builder=new org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
  HotRodServer server=server(0);
  builder.addServers(server.getHost() + ":" + server.getPort());
  builder.balancingStrategy(StickyServerLoadBalancingStrategy.class);
  RemoteCacheManager newClient=new RemoteCacheManager(builder.build());
  try {
    WithStateEventLogListener<Integer> statefulListener=new WithStateEventLogListener<>();
    EventLogListener<Integer> statelessListener=new EventLogListener<>();
    FailoverEventLogListener<Integer> failoverListener=new FailoverEventLogListener<>();
    RemoteCache<Integer,String> c=newClient.getCache();
    c.put(0,"zero");
    c.remove(0);
    c.addClientListener(statelessListener);
    c.addClientListener(statefulListener);
    c.addClientListener(failoverListener);
    c.put(1,"one");
    statefulListener.expectOnlyCreatedEvent(1,cache(0));
    statelessListener.expectOnlyCreatedEvent(1,cache(0));
    failoverListener.expectOnlyCreatedEvent(1,cache(0));
    findServerAndKill(newClient,servers,cacheManagers);
    c.put(2,"two");
    statelessListener.expectNoEvents();
    statefulListener.expectFailoverEvent();
    failoverListener.expectFailoverEvent();
    statelessListener.expectNoEvents();
    failoverListener.expectNoEvents();
    statefulListener.expectUnorderedEvents(ClientEvent.Type.CLIENT_CACHE_ENTRY_CREATED,1,2);
    c.remove(1);
    c.remove(2);
  }
  finally {
    killRemoteCacheManager(newClient);
  }
}
