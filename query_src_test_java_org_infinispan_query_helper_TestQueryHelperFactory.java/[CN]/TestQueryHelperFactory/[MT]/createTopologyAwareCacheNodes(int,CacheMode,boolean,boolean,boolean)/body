{
  List caches=new ArrayList();
  ConfigurationBuilder builder=AbstractCacheTest.getDefaultClusteredCacheConfig(cacheMode,transactional);
  builder.indexing().index(indexLocalOnly ? Index.LOCAL : Index.ALL);
  if (isRamDirectoryProvider) {
    builder.indexing().addProperty("default.directory_provider","ram").addProperty("lucene_version","LUCENE_CURRENT");
  }
 else {
    builder.indexing().addProperty("hibernate.search.default.indexmanager","org.infinispan.query.indexmanager.InfinispanIndexManager").addProperty("default.directory_provider","infinispan").addProperty("hibernate.search.default.exclusive_index_use","false").addProperty("lucene_version","LUCENE_48");
    if (cacheMode.isClustered()) {
      builder.clustering().stateTransfer().fetchInMemoryState(true);
    }
  }
  for (int i=0; i < numberOfNodes; i++) {
    GlobalConfigurationBuilder globalConfigurationBuilder=GlobalConfigurationBuilder.defaultClusteredBuilder();
    globalConfigurationBuilder.transport().machineId("a" + i).rackId("b" + i).siteId("test" + i);
    EmbeddedCacheManager cm1=TestCacheManagerFactory.createClusteredCacheManager(globalConfigurationBuilder,builder);
    caches.add(cm1.getCache());
  }
  return caches;
}
