{
  if (legacy == null)   return null;
  ConfigurationBuilder builder=new ConfigurationBuilder();
  builder.clustering().cacheMode(org.infinispan.configuration.cache.CacheMode.valueOf(legacy.getCacheMode().name()));
  if (!legacy.getCacheMode().isSynchronous()) {
    if (legacy.isUseAsyncMarshalling())     builder.clustering().async().asyncMarshalling();
 else     builder.clustering().async().syncMarshalling();
    builder.clustering().async().replQueue(Util.<ReplicationQueue>getInstance(legacy.getReplQueueClass(),legacy.getClassLoader())).replQueueInterval(legacy.getReplQueueInterval()).replQueueMaxElements(legacy.getReplQueueMaxElements()).useReplQueue(legacy.isUseReplQueue());
  }
  if (legacy.isCustomConsistentHashClass()) {
    builder.clustering().hash().consistentHash(Util.<ConsistentHash>getInstance(legacy.getConsistentHashClass(),legacy.getClassLoader()));
  }
  if (legacy.isCustomHashFunctionClass()) {
    builder.clustering().hash().hash(Util.<Hash>getInstance(legacy.getHashFunctionClass(),legacy.getClassLoader()));
  }
  builder.clustering().stateTransfer().fetchInMemoryState(legacy.isFetchInMemoryState()).timeout(legacy.getStateRetrievalTimeout()).chunkSize(legacy.getStateRetrievalChunkSize());
  if (legacy.isHashActivated()) {
    builder.clustering().hash().numOwners(legacy.getNumOwners()).numVirtualNodes(legacy.getNumVirtualNodes()).rehashEnabled(legacy.isRehashEnabled()).rehashRpcTimeout(legacy.getRehashRpcTimeout()).rehashWait(legacy.getRehashWaitTime()).groups().enabled(legacy.isGroupsEnabled()).withGroupers(legacy.getGroupers());
  }
  if (legacy.isL1CacheEnabled() && legacy.getCacheMode().isDistributed()) {
    builder.clustering().l1().enable();
    builder.clustering().l1().onRehash(legacy.isL1OnRehash());
  }
 else {
    builder.clustering().l1().disable();
  }
  builder.clustering().l1().invalidationThreshold(legacy.getL1InvalidationThreshold()).lifespan(legacy.getL1Lifespan()).cleanupTaskFrequency(legacy.getL1InvalidationCleanupTaskFrequency());
  if (legacy.getCacheMode().isDistributed()) {
    builder.clustering().stateTransfer().fetchInMemoryState(legacy.isRehashEnabled()).timeout(legacy.getRehashWaitTime());
  }
 else   if (legacy.getCacheMode().isClustered()) {
    builder.clustering().stateTransfer().fetchInMemoryState(legacy.isFetchInMemoryState()).timeout(legacy.getStateRetrievalTimeout());
  }
  builder.clustering().stateTransfer().chunkSize(legacy.getStateRetrievalChunkSize());
  if (legacy.getCacheMode().isSynchronous()) {
    builder.clustering().sync().replTimeout(legacy.getSyncReplTimeout());
  }
  for (  CustomInterceptorConfig interceptor : legacy.getCustomInterceptors()) {
    InterceptorConfigurationBuilder interceptorConfigurationBuilder=builder.clustering().customInterceptors().addInterceptor();
    interceptorConfigurationBuilder.interceptor(interceptor.getInterceptor());
    if (interceptor.getAfter() != null && !interceptor.getAfter().isEmpty())     interceptorConfigurationBuilder.after(Util.<CommandInterceptor>loadClass(interceptor.getAfter(),legacy.getClassLoader()));
 else     if (interceptor.getBefore() != null && !interceptor.getBefore().isEmpty())     interceptorConfigurationBuilder.before(Util.<CommandInterceptor>loadClass(interceptor.getBefore(),legacy.getClassLoader()));
 else     if (!interceptor.getPositionAsString().equals(Position.OTHER_THAN_FIRST_OR_LAST.toString()))     interceptorConfigurationBuilder.position(Position.valueOf(interceptor.getPositionAsString()));
 else     interceptorConfigurationBuilder.index(interceptor.getIndex());
  }
  builder.dataContainer().dataContainer(legacy.getDataContainer()).withProperties(legacy.getDataContainerProperties());
  if (legacy.isDeadlockDetectionEnabled()) {
    builder.deadlockDetection().enable().spinDuration(legacy.getDeadlockDetectionSpinDuration());
  }
 else {
    builder.deadlockDetection().disable();
  }
  builder.eviction().maxEntries(legacy.getEvictionMaxEntries()).strategy(legacy.getEvictionStrategy()).threadPolicy(legacy.getEvictionThreadPolicy());
  builder.expiration().lifespan(legacy.getExpirationLifespan()).maxIdle(legacy.getExpirationMaxIdle()).reaperEnabled(legacy.isExpirationReaperEnabled()).wakeUpInterval(legacy.getExpirationWakeUpInterval());
  if (legacy.isIndexingEnabled())   builder.indexing().enable().indexLocalOnly(legacy.isIndexLocalOnly()).withProperties(legacy.getIndexingProperties());
 else   builder.indexing().disable();
  if (legacy.isInvocationBatchingEnabled()) {
    builder.invocationBatching().enable();
  }
 else {
    builder.invocationBatching().disable();
  }
  builder.jmxStatistics().enabled(legacy.isExposeJmxStatistics());
  builder.loaders().passivation(legacy.isCacheLoaderPassivation()).preload(legacy.isCacheLoaderPreload()).shared(legacy.isCacheLoaderShared());
  for (  CacheLoaderConfig clc : legacy.getCacheLoaders()) {
    adapt(legacy.getClassLoader(),builder,clc);
  }
  builder.locking().concurrencyLevel(legacy.getConcurrencyLevel()).isolationLevel(legacy.getIsolationLevel()).lockAcquisitionTimeout(legacy.getLockAcquisitionTimeout()).useLockStriping(legacy.isUseLockStriping()).writeSkewCheck(legacy.isWriteSkewCheck());
  if (legacy.isStoreAsBinary())   builder.storeAsBinary().enable().storeKeysAsBinary(legacy.isStoreKeysAsBinary()).storeValuesAsBinary(legacy.isStoreValuesAsBinary());
 else   builder.storeAsBinary().disable();
  builder.transaction().autoCommit(legacy.isTransactionAutoCommit()).cacheStopTimeout(legacy.getCacheStopTimeout()).eagerLockingSingleNode(legacy.isEagerLockSingleNode()).lockingMode(legacy.getTransactionLockingMode()).syncCommitPhase(legacy.isSyncCommitPhase()).syncRollbackPhase(legacy.isSyncRollbackPhase()).transactionMode(legacy.getTransactionMode()).transactionSynchronizationRegistryLookup(legacy.getTransactionSynchronizationRegistryLookup()).useEagerLocking(legacy.isUseEagerLocking()).useSynchronization(legacy.isUseSynchronizationForTransactions()).use1PcForAutoCommitTransactions(legacy.isUse1PcForAutoCommitTransactions());
  TransactionManagerLookup tmLookup=legacy.getTransactionManagerLookup();
  if (tmLookup != null) {
    builder.transaction().transactionManagerLookup(tmLookup);
  }
 else {
    String tmLookupClass=legacy.getTransactionManagerLookupClass();
    if (tmLookupClass != null) {
      builder.transaction().transactionManagerLookup(Util.<TransactionManagerLookup>getInstance(tmLookupClass,Thread.currentThread().getContextClassLoader()));
    }
  }
  builder.versioning().enabled(legacy.isEnableVersioning()).scheme(legacy.getVersioningScheme());
  builder.transaction().recovery().enabled(legacy.isTransactionRecoveryEnabled());
  builder.unsafe().unreliableReturnValues(legacy.isUnsafeUnreliableReturnValues());
  return builder.build();
}
