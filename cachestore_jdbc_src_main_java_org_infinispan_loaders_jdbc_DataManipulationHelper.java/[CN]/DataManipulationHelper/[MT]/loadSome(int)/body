{
  Connection conn=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    String sql=tableManipulation.getLoadSomeRowsSql();
    if (log.isTraceEnabled()) {
      log.trace("Running sql '" + sql);
    }
    conn=connectionFactory.getConnection();
    if (tableManipulation.isVariableLimitSupported()) {
      ps=conn.prepareStatement(sql);
      ps.setInt(1,maxEntries);
    }
 else {
      ps=conn.prepareStatement(sql.replace("?",String.valueOf(maxEntries)));
    }
    rs=ps.executeQuery();
    rs.setFetchSize(tableManipulation.getFetchSize());
    Set<InternalCacheEntry> result=new HashSet<InternalCacheEntry>(maxEntries);
    while (rs.next()) {
      loadAllProcess(rs,result);
    }
    return result;
  }
 catch (  SQLException e) {
    log.sqlFailureFetchingAllStoredEntries(e);
    throw new CacheLoaderException("SQL error while fetching all StoredEntries",e);
  }
 finally {
    JdbcUtil.safeClose(rs);
    JdbcUtil.safeClose(ps);
    connectionFactory.releaseConnection(conn);
  }
}
