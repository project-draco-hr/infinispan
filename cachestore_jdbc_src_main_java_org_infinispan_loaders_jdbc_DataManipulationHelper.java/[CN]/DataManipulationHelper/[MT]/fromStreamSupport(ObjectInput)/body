{
  Connection conn=null;
  PreparedStatement ps=null;
  try {
    conn=connectionFactory.getConnection();
    String sql=tableManipulation.getInsertRowSql();
    ps=conn.prepareStatement(sql);
    int readCount=0;
    int batchSize=tableManipulation.getBatchSize();
    Object objFromStream=marshaller.objectFromObjectStream(objectInput);
    while (fromStreamProcess(objFromStream,ps,objectInput)) {
      ps.addBatch();
      readCount++;
      if (readCount % batchSize == 0) {
        ps.executeBatch();
        if (log.isTraceEnabled()) {
          log.trace("Executing batch " + readCount / batchSize + ", batch size is " + batchSize);
        }
      }
      objFromStream=marshaller.objectFromObjectStream(objectInput);
    }
    if (readCount % batchSize != 0) {
      ps.executeBatch();
    }
    if (log.isTraceEnabled()) {
      log.trace("Successfully inserted " + readCount + " buckets into the database, batch size is "+ batchSize);
    }
  }
 catch (  IOException ex) {
    logAndThrow(ex,"I/O failure while integrating state into store");
  }
catch (  SQLException e) {
    logAndThrow(e,"SQL failure while integrating state into store");
  }
catch (  ClassNotFoundException e) {
    logAndThrow(e,"Unexpected failure while integrating state into store");
  }
 finally {
    JdbcUtil.safeClose(ps);
    connectionFactory.releaseConnection(conn);
  }
}
