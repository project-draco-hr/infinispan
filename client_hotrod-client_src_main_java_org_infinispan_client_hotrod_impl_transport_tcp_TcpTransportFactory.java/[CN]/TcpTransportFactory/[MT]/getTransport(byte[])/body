{
  InetSocketAddress server;
  if (consistentHash != null) {
    server=consistentHash.getServer(key);
    if (log.isTraceEnabled()) {
      log.trace("Using consistent hash for determining the server: " + server);
    }
  }
 else {
    server=balancer.nextServer();
    if (log.isTraceEnabled()) {
      log.trace("Using the balancer for determining the server: " + server);
    }
  }
  return borrowTransportFromPool(server);
}
