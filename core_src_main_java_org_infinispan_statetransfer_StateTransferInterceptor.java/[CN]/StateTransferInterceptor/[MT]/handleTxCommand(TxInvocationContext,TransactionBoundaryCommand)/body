{
  Address origin=ctx.isOriginLocal() ? ctx.getOrigin() : ctx.getGlobalTransaction().getAddress();
  if (trace)   log.tracef("handleTxCommand for command %s, origin %s",command,origin);
  if (isLocalOnly(ctx,command)) {
    return invokeNextInterceptor(ctx,command);
  }
  updateTopologyId(command);
  int retryTopologyId=-1;
  Object localResult=null;
  try {
    localResult=invokeNextInterceptor(ctx,command);
  }
 catch (  OutdatedTopologyException e) {
    retryTopologyId=Math.max(currentTopologyId(),command.getTopologyId() + 1);
  }
  boolean async=isTxCommandAsync(command);
  if (async) {
    stateTransferManager.forwardCommandIfNeeded(command,getAffectedKeys(ctx,command),origin,false);
    return null;
  }
  if (ctx.isOriginLocal()) {
    if (retryTopologyId > 0) {
      command.setTopologyId(retryTopologyId);
      waitForTransactionData(retryTopologyId);
      log.tracef("Retrying command %s for topology %d",command,retryTopologyId);
      localResult=handleTxCommand(ctx,command);
    }
  }
 else {
    if (currentTopologyId() > command.getTopologyId()) {
      localResult=UnsureResponse.INSTANCE;
    }
  }
  return localResult;
}
