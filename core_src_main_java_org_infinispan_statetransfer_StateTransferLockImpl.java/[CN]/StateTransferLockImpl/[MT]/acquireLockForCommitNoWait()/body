{
  if (!writesBlocked) {
    int previousWrites=runningWritesCount.getAndIncrement();
    if (previousWrites > 0 || !writesBlocked) {
      if (trace) {
        if (traceThreadWrites.get() == Boolean.TRUE)         log.error("Trying to acquire state transfer shared lock, but this thread already has it",new Exception());
        traceThreadWrites.set(Boolean.TRUE);
        log.tracef("Acquired shared state transfer shared lock (for commit), total holders: %d",runningWritesCount.get());
      }
      return true;
    }
    runningWritesCount.decrementAndGet();
synchronized (lock) {
      lock.notifyAll();
    }
  }
  return false;
}
