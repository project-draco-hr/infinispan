{
  int cmdTopologyId=command.getTopologyId();
  CacheTopology cacheTopology=getCacheTopology();
  int localTopologyId=cacheTopology != null ? cacheTopology.getTopologyId() : -1;
  if (trace) {
    log.tracef("CommandTopologyId=%s, localTopologyId=%s",cmdTopologyId,localTopologyId);
  }
  if (cmdTopologyId < localTopologyId) {
    ConsistentHash writeCh=cacheTopology.getWriteConsistentHash();
    Set<Address> newTargets=new HashSet<Address>(writeCh.locateAllOwners(affectedKeys));
    newTargets.remove(rpcManager.getAddress());
    newTargets.remove(origin);
    if (!newTargets.isEmpty()) {
      command.setTopologyId(localTopologyId);
      if (trace) {
        log.tracef("Forwarding command %s to new targets %s",command,newTargets);
      }
      return rpcManager.invokeRemotely(newTargets,command,rpcManager.getDefaultRpcOptions(sync,DeliverOrder.NONE));
    }
  }
  return Collections.emptyMap();
}
