{
  if (this == o)   return true;
  if (o == null || MarshalledValue.class != o.getClass()) {
    return false;
  }
  MarshalledValue that=(MarshalledValue)o;
  final boolean preferInstanceEquality=equalityPreferenceForInstance && that.equalityPreferenceForInstance;
  Object thisInstance=this.instance;
  Object thatInstance=that.instance;
  if (preferInstanceEquality && thisInstance != null && thatInstance != null) {
    return thisInstance.equals(thatInstance);
  }
  MarshalledValueByteStream thisRaw=this.raw;
  MarshalledValueByteStream thatRaw=that.raw;
  if (thisRaw != null && thatRaw != null)   return thisRaw.equals(thatRaw);
  if (thisInstance != null && thatInstance != null) {
    return thisInstance.equals(thatInstance);
  }
  if (preferInstanceEquality) {
    if (thisInstance == null) {
      thisInstance=this.deserialize();
    }
    if (thatInstance == null) {
      thatInstance=that.deserialize();
    }
    return thisInstance.equals(thatInstance);
  }
 else {
    if (thisRaw == null) {
      thisRaw=this.serialize();
    }
    if (thatRaw == null) {
      thatRaw=that.serialize();
    }
    return thisRaw.equals(thatRaw);
  }
}
