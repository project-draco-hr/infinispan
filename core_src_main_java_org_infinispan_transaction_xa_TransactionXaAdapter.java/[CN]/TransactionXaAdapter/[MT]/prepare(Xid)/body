{
  if (configuration.isOnePhaseCommit()) {
    if (log.isTraceEnabled())     log.trace("Recieved prepare for tx: " + xid + " . Skipping call as 1PC will be used.");
    return XA_OK;
  }
  PrepareCommand prepareCommand=commandsFactory.buildPrepareCommand(transactionIdentifier,modifications,configuration.isOnePhaseCommit());
  if (log.isTraceEnabled())   log.trace("Sending prepare command through the chain: " + prepareCommand);
  InitiatorTxInvocationContext ctx=icc.getInitiatorTxInvocationContext();
  ctx.setXaCache(this);
  try {
    invoker.invoke(ctx,prepareCommand);
    return XA_OK;
  }
 catch (  Throwable e) {
    log.error("Error while processing PrepareCommand",e);
    throw new XAException(XAException.XAER_RMERR);
  }
}
