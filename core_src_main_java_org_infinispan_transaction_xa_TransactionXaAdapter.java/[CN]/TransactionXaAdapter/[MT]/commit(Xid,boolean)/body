{
  if (isOnePhase)   prepare(xid);
  if (trace)   log.trace("committing TransactionXaAdapter: " + globalTx);
  try {
    LocalTxInvocationContext ctx=icc.createTxInvocationContext();
    ctx.setXaCache(this);
    if (configuration.isOnePhaseCommit()) {
      checkMarkedForRollback();
      if (trace)       log.trace("Doing an 1PC prepare call on the interceptor chain");
      PrepareCommand command=commandsFactory.buildPrepareCommand(globalTx,modifications,true);
      try {
        invoker.invoke(ctx,command);
      }
 catch (      Throwable e) {
        log.error("Error while processing 1PC PrepareCommand",e);
        throw new XAException(XAException.XAER_RMERR);
      }
    }
 else {
      CommitCommand commitCommand=commandsFactory.buildCommitCommand(globalTx);
      try {
        invoker.invoke(ctx,commitCommand);
      }
 catch (      Throwable e) {
        log.error("Error while processing 1PC PrepareCommand",e);
        throw new XAException(XAException.XAER_RMERR);
      }
    }
  }
  finally {
    txTable.removeLocalTransaction(transaction);
    icc.suspend();
    this.modifications=null;
  }
}
