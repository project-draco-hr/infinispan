{
  QueryInterceptor queryInterceptor=cr.getComponent(QueryInterceptor.class);
  if (queryInterceptor == null) {
    queryInterceptor=buildQueryInterceptor(cfg,searchFactory);
    ConfigurationBuilder builder=new ConfigurationBuilder();
    InterceptorConfigurationBuilder interceptorBuilder=builder.customInterceptors().addInterceptor();
    interceptorBuilder.interceptor(queryInterceptor);
    if (!cfg.transaction().transactionMode().isTransactional()) {
      interceptorBuilder.after(NonTransactionalLockingInterceptor.class);
    }
 else     if (cfg.transaction().lockingMode() == LockingMode.OPTIMISTIC) {
      interceptorBuilder.after(OptimisticLockingInterceptor.class);
    }
 else {
      interceptorBuilder.after(PessimisticLockingInterceptor.class);
    }
    cfg.customInterceptors().interceptors(builder.build().customInterceptors().interceptors());
  }
}
