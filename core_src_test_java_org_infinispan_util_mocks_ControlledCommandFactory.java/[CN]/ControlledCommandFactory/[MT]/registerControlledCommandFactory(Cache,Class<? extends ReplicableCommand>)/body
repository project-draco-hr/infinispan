{
  AdvancedCache advancedCache=cache.getAdvancedCache();
  ComponentRegistry componentRegistry=advancedCache.getComponentRegistry();
  final ControlledCommandFactory ccf=new ControlledCommandFactory(componentRegistry.getCommandsFactory(),toBlock);
  TestingUtil.replaceField(ccf,"commandsFactory",componentRegistry,ComponentRegistry.class);
  advancedCache.getComponentRegistry().getGlobalComponentRegistry().registerNamedComponentRegistry(componentRegistry,EmbeddedCacheManager.DEFAULT_CACHE_NAME);
  return ccf;
}
