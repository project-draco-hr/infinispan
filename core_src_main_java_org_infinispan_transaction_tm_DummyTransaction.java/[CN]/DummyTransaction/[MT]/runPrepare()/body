{
  boolean successfulInit=notifyBeforeCompletion();
  if (successfulInit) {
    status=Status.STATUS_PREPARING;
  }
 else {
    status=Status.STATUS_ROLLING_BACK;
  }
  DummyTransaction transaction=tm_.getTransaction();
  Collection<XAResource> resources=transaction.getEnlistedResources();
  for (  XAResource res : resources) {
    try {
      int prepareStatus=res.prepare(xid);
      transaction.setPrepareStatus(prepareStatus);
    }
 catch (    XAException e) {
      log.trace("The resource wants to rollback!",e);
      status=Status.STATUS_ROLLING_BACK;
      return false;
    }
catch (    Throwable th) {
      log.unexpectedErrorFromResourceManager(th);
      throw new SystemException(th.getMessage());
    }
  }
  status=Status.STATUS_PREPARED;
  return true;
}
