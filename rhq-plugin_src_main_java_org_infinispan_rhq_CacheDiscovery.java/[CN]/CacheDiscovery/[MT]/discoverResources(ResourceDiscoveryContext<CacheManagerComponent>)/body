{
  boolean trace=log.isTraceEnabled();
  if (trace)   log.trace("Discover resources with context");
  Set<DiscoveredResourceDetails> discoveredResources=new HashSet<DiscoveredResourceDetails>();
  EmsConnection conn=ctx.getParentResourceComponent().getEmsConnection();
  if (trace)   log.trace("Connection to ems server established");
  String pattern=getAllCachesPattern(ctx.getParentResourceContext().getResourceKey());
  if (trace)   log.tracef("Pattern to query is %s",pattern);
  ObjectNameQueryUtility queryUtility=new ObjectNameQueryUtility(pattern);
  List<EmsBean> beans=conn.queryBeans(queryUtility.getTranslatedQuery());
  if (trace)   log.tracef("Querying [%s] returned beans: %s",queryUtility.getTranslatedQuery(),beans);
  for (  EmsBean bean : beans) {
    String name=bean.getAttribute("CacheName").getValue().toString();
    String mbeanCacheName=bean.getBeanName().getKeyProperty("name");
    if (trace)     log.tracef("Resource name is %s and resource key %s",name,mbeanCacheName);
    DiscoveredResourceDetails detail=new DiscoveredResourceDetails(ctx.getResourceType(),mbeanCacheName,name,null,"One cache within Infinispan",ctx.getDefaultPluginConfiguration(),null);
    discoveredResources.add(detail);
    log.info("Discovered new ...  " + bean.getBeanName().getCanonicalName());
  }
  return discoveredResources;
}
