{
  final InputStream in=System.in;
  HornetQBootstrapServer.main(new String[]{"hornetq-beans.xml"});
  HotRodServerConfigurationBuilder builder=new HotRodServerConfigurationBuilder();
  HotRodServer server=new HotRodServer();
  EmbeddedCacheManager cm=new DefaultCacheManager();
  server.start(builder.build(),cm);
  Context ctx=new InitialContext();
  Connection con=null;
  try {
    con=((ConnectionFactory)ctx.lookup("/ConnectionFactory")).createConnection();
    con.start();
    Session s=con.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Topic topic=(Topic)ctx.lookup("/topic/datagrid");
    cm.getCache().addListener(new InvalidationProducer(s,topic));
  }
  finally {
    while (in.read() != -1) {
    }
    ctx.close();
    if (con != null)     con.close();
    server.stop();
    cm.stop();
    System.exit(0);
  }
}
