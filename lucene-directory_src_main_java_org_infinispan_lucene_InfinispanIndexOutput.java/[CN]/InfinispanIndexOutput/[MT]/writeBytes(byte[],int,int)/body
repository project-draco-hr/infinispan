{
  int writtenBytes=0;
  while (writtenBytes < length) {
    int pieceLength=Math.min(buffer.length - bufferPosition,length - writtenBytes);
    System.arraycopy(b,offset + writtenBytes,buffer,bufferPosition,pieceLength);
    bufferPosition+=pieceLength;
    filePosition+=pieceLength;
    writtenBytes+=pieceLength;
    if (isNewChunkNeeded()) {
      newChunk();
    }
  }
}
