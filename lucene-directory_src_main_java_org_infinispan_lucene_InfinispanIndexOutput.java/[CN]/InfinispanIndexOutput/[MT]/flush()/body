{
  chunkNumber=getChunkNumberFromPosition(filePosition - 1,bufferSize);
  ChunkCacheKey key=new ChunkCacheKey(fileKey.getIndexName(),fileKey.getFileName(),chunkNumber);
  file.touch();
  if (file.getSize() < filePosition) {
    file.setSize(filePosition);
  }
  int newBufferSize=(int)(file.getSize() % bufferSize);
  byte[] shortedBuffer;
  if (newBufferSize != 0) {
    shortedBuffer=new byte[newBufferSize];
    System.arraycopy(buffer,0,shortedBuffer,0,newBufferSize);
  }
 else {
    shortedBuffer=buffer;
  }
  cache.startBatch();
  cache.withFlags(Flag.SKIP_REMOTE_LOOKUP).put(key,shortedBuffer);
  cache.withFlags(Flag.SKIP_REMOTE_LOOKUP).put(fileKey,file);
  cache.endBatch(true);
}
