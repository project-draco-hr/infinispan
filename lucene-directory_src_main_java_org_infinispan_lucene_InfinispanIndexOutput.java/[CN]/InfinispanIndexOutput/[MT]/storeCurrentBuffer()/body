{
  resizeFileIfNeeded();
  byte[] bufferToFlush=buffer;
  boolean writingOnLastChunk=isWritingOnLastChunk();
  if (writingOnLastChunk) {
    int newBufferSize=(int)(file.getSize() % bufferSize);
    if (newBufferSize != 0) {
      bufferToFlush=new byte[newBufferSize];
      System.arraycopy(buffer,0,bufferToFlush,0,newBufferSize);
    }
  }
  boolean microbatch=cache.startBatch();
  if (!writingOnLastChunk || this.positionInBuffer != 0) {
    ChunkCacheKey key=new ChunkCacheKey(fileKey.getIndexName(),fileKey.getFileName(),currentChunkNumber);
    if (trace)     log.trace("Storing segment chunk: " + key);
    cache.withFlags(Flag.SKIP_REMOTE_LOOKUP,Flag.SKIP_LOCKING).put(key,bufferToFlush);
  }
  file.touch();
  cache.withFlags(Flag.SKIP_REMOTE_LOOKUP,Flag.SKIP_LOCKING).put(fileKey,file);
  registerToFileListIfNeeded();
  if (microbatch)   cache.endBatch(true);
}
