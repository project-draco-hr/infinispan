{
  resizeFileIfNeeded();
  byte[] bufferToFlush=buffer;
  boolean writingOnLastChunk=isWritingOnLastChunk();
  if (writingOnLastChunk) {
    int newBufferSize=(int)(file.getSize() % bufferSize);
    if (newBufferSize != 0) {
      bufferToFlush=new byte[newBufferSize];
      System.arraycopy(buffer,0,bufferToFlush,0,newBufferSize);
    }
  }
  boolean microbatch=false;
  if (!writingOnLastChunk || this.positionInBuffer != 0) {
    if (chunksCache == metadataCache) {
      microbatch=chunksCache.startBatch();
    }
    ChunkCacheKey key=new ChunkCacheKey(fileKey.getIndexName(),fileKey.getFileName(),currentChunkNumber);
    if (trace)     log.trace("Storing segment chunk: " + key);
    chunksCache.withFlags(Flag.SKIP_REMOTE_LOOKUP,Flag.SKIP_CACHE_LOAD,Flag.SKIP_LOCKING).put(key,bufferToFlush);
  }
  file.touch();
  metadataCache.withFlags(Flag.SKIP_REMOTE_LOOKUP,Flag.SKIP_CACHE_LOAD,Flag.SKIP_LOCKING).put(fileKey,file);
  registerToFileListIfNeeded();
  if (microbatch)   chunksCache.endBatch(true);
}
