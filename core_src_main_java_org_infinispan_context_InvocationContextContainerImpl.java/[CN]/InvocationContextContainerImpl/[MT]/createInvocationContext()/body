{
  Transaction tx=getRunningTx();
  InvocationContext existing=icTl.get();
  if (tx != null) {
    LocalTxInvocationContext localContext;
    if ((existing == null) || !(existing instanceof LocalTxInvocationContext)) {
      localContext=new LocalTxInvocationContext();
      icTl.set(localContext);
    }
 else {
      localContext=(LocalTxInvocationContext)existing;
    }
    TransactionXaAdapter xaAdapter=transactionTable.getXaCacheAdapter(tx);
    localContext.setXaCache(xaAdapter);
    return localContext;
  }
 else {
    NonTxInvocationContext nonTxContext;
    if ((existing == null) || !(existing instanceof NonTxInvocationContext)) {
      nonTxContext=new NonTxInvocationContext();
      icTl.set(nonTxContext);
    }
 else {
      nonTxContext=(NonTxInvocationContext)existing;
    }
    nonTxContext.setOriginLocal(true);
    return nonTxContext;
  }
}
