{
  Configuration config=getDefaultClusteredConfig(Configuration.CacheMode.DIST_SYNC);
  config.setUnsafeUnreliableReturnValues(true);
  config.setNumOwners(1);
  config.setEnableDeadlockDetection(true);
  EmbeddedCacheManager cm1=TestCacheManagerFactory.createCacheManager(config,true);
  EmbeddedCacheManager cm2=TestCacheManagerFactory.createCacheManager(config,true);
  registerCacheManager(cm1);
  registerCacheManager(cm2);
  TestingUtil.blockUntilViewsReceived(10000,cache(0),cache(1));
  BaseDistFunctionalTest.RehashWaiter.waitForInitRehashToComplete(cache(0),cache(1));
  cas=KeyAffinityServiceFactory.newKeyAffinityService(cache(0),new Executor(){
    public void execute(    Runnable command){
      new Thread(command).start();
    }
  }
,new RndKeyGenerator(),2,true);
  rpcManager0=DldLazyLockingReplicationTest.replaceRpcManager(cache(0));
  rpcManager1=DldLazyLockingReplicationTest.replaceRpcManager(cache(1));
}
