{
  PendingLockPromise pendingLockPromise=pendingLockPromiseMap.remove(ctx.getGlobalTransaction());
  if (trace) {
    log.tracef("Await for pending transactions using %s",pendingLockPromise);
  }
  if (pendingLockPromise != null) {
    return awaitOn(pendingLockPromise,ctx.getGlobalTransaction(),time,unit);
  }
  final int txTopologyId=getTopologyId(ctx);
  if (txTopologyId != NO_PENDING_CHECK) {
    return checkForPendingLock(key,ctx.getGlobalTransaction(),txTopologyId,unit.toMillis(time));
  }
  if (trace) {
    log.tracef("Locking key %s, no need to check for pending locks.",toStr(key));
  }
  return unit.toMillis(time);
}
