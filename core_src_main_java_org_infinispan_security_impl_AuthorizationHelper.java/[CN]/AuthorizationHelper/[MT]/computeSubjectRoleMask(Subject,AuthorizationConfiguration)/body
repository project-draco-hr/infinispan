{
  if (subject != null) {
    Integer cachedMask;
    try {
      cachedMask=maskCache != null ? maskCache.get(maskCacheScope,subject) : null;
    }
 catch (    IllegalStateException e) {
      cachedMask=null;
    }
    if (cachedMask != null) {
      return cachedMask;
    }
 else {
      int mask=0;
      PrincipalRoleMapper roleMapper=globalConfiguration.authorization().principalRoleMapper();
      for (      Principal principal : subject.getPrincipals()) {
        Set<String> roleNames=roleMapper.principalToRoles(principal);
        if (roleNames != null) {
          for (          String roleName : roleNames) {
            if (configuration != null && !configuration.roles().contains(roleName))             continue;
            Role role=globalConfiguration.authorization().roles().get(roleName);
            if (role != null) {
              mask|=role.getMask();
            }
          }
        }
      }
      try {
        if (maskCache != null) {
          maskCache.put(maskCacheScope,subject,mask,globalConfiguration.securityCacheTimeout(),TimeUnit.MILLISECONDS);
        }
      }
 catch (      IllegalStateException e) {
      }
      return mask;
    }
  }
 else {
    return 0;
  }
}
