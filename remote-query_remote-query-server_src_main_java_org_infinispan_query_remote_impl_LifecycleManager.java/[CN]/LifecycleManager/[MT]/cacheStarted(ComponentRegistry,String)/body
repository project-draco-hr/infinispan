{
  Configuration configuration=cr.getComponent(Configuration.class);
  boolean isIndexed=configuration.indexing().index().isEnabled();
  boolean isCompatMode=configuration.compatibility().enabled();
  boolean remoteValueWrappingEnabled=isIndexed && !isCompatMode;
  if (remoteValueWrappingEnabled) {
    if (!verifyChainContainsRemoteValueWrapperInterceptor(cr)) {
      throw new IllegalStateException("It was expected to find the RemoteValueWrapperInterceptor registered in the InterceptorChain but it wasn't found");
    }
  }
 else   if (verifyChainContainsRemoteValueWrapperInterceptor(cr)) {
    throw new IllegalStateException("It was NOT expected to find the RemoteValueWrapperInterceptor registered in the InterceptorChain as indexing was disabled, but it was found");
  }
  InternalCacheRegistry icr=cr.getGlobalComponentRegistry().getComponent(InternalCacheRegistry.class);
  if (!icr.isInternalCache(cacheName)) {
    AdvancedCache<?,?> cache=cr.getComponent(Cache.class).getAdvancedCache().withFlags(Flag.OPERATION_HOTROD);
    SerializationContext serCtx=ProtobufMetadataManagerImpl.getSerializationContextInternal(cache.getCacheManager());
    SearchManager searchManager=isIndexed ? Search.getSearchManager(cache) : null;
    RemoteQueryEngine remoteQueryEngine=new RemoteQueryEngine(cache,searchManager,isCompatMode,serCtx);
    cr.registerComponent(remoteQueryEngine,RemoteQueryEngine.class);
  }
}
