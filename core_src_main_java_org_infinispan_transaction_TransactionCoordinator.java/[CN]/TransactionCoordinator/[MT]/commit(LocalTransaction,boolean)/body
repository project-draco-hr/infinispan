{
  if (trace)   log.tracef("Committing transaction %s",localTransaction.getGlobalTransaction());
  LocalTxInvocationContext ctx=icc.createTxInvocationContext();
  ctx.setLocalTransaction(localTransaction);
  if (Configurations.isOnePhaseCommit(configuration) || isOnePhase || is1PcForAutoCommitTransaction(localTransaction)) {
    validateNotMarkedForRollback(localTransaction);
    if (trace)     log.trace("Doing an 1PC prepare call on the interceptor chain");
    PrepareCommand command=commandsFactory.buildPrepareCommand(localTransaction.getGlobalTransaction(),localTransaction.getModifications(),true);
    try {
      invoker.invoke(ctx,command);
    }
 catch (    Throwable e) {
      handleCommitFailure(e,localTransaction,true);
    }
  }
 else {
    CommitCommand commitCommand=commandCreator.createCommitCommand(localTransaction.getGlobalTransaction());
    try {
      invoker.invoke(ctx,commitCommand);
      txTable.removeLocalTransaction(localTransaction);
    }
 catch (    Throwable e) {
      handleCommitFailure(e,localTransaction,false);
    }
  }
}
