{
  if (trace)   log.tracef("Committing transaction %s",localTransaction.getGlobalTransaction());
  LocalTxInvocationContext ctx=icc.createTxInvocationContext();
  ctx.setLocalTransaction(localTransaction);
  if (isOnePhaseCommit(localTransaction) || isOnePhase) {
    validateNotMarkedForRollback(localTransaction);
    if (trace)     log.trace("Doing an 1PC prepare call on the interceptor chain");
    List<WriteCommand> modifications=localTransaction.getModifications();
    PrepareCommand command=commandCreator.createPrepareCommand(localTransaction.getGlobalTransaction(),modifications,true);
    try {
      invoker.invoke(ctx,command);
    }
 catch (    Throwable e) {
      handleCommitFailure(e,localTransaction,true);
    }
    return true;
  }
 else {
    CommitCommand commitCommand=commandCreator.createCommitCommand(localTransaction.getGlobalTransaction());
    try {
      invoker.invoke(ctx,commitCommand);
      txTable.removeLocalTransaction(localTransaction);
    }
 catch (    Throwable e) {
      handleCommitFailure(e,localTransaction,false);
    }
    return false;
  }
}
