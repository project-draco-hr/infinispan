{
  if (ctx.isInTxScope() && !isFromStateTransfer(ctx)) {
    Metadata commitMetadata;
    ClusteredRepeatableReadEntry clusterMvccEntry=(ClusteredRepeatableReadEntry)entry;
    EntryVersion existingVersion=clusterMvccEntry.getMetadata().version();
    EntryVersion newVersion;
    if (existingVersion == null) {
      newVersion=versionGenerator.generateNew();
    }
 else {
      newVersion=versionGenerator.increment((IncrementableEntryVersion)existingVersion);
    }
    if (metadata == null)     commitMetadata=new EmbeddedMetadata.Builder().version(newVersion).build();
 else     commitMetadata=metadata.builder().version(newVersion).build();
    cdl.commitEntry(entry,commitMetadata,command,ctx);
  }
 else {
    cdl.commitEntry(entry,entry.getMetadata(),command,ctx);
  }
}
