{
  Map<Object,Integer> refMap=useRefs ? new IdentityHashMap<Object,Integer>() : null;
  ClassLoader toUse=defaultClassLoader;
  Thread current=Thread.currentThread();
  ClassLoader old=current.getContextClassLoader();
  if (old != null)   toUse=old;
  try {
    current.setContextClassLoader(toUse);
    marshallObject(o,out,refMap);
  }
  finally {
    current.setContextClassLoader(old);
  }
}
