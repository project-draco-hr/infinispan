{
  String jpqlString=accept(new JPAQueryGenerator());
  if (log.isTraceEnabled()) {
    log.tracef("JPQL string : %s",jpqlString);
  }
  LuceneQueryParsingResult parsingResult;
  if (queryCache != null) {
    KeyValuePair<String,Class> queryCacheKey=new KeyValuePair<String,Class>(jpqlString,LuceneQueryParsingResult.class);
    parsingResult=queryCache.get(queryCacheKey);
    if (parsingResult == null) {
      parsingResult=parse(jpqlString);
      queryCache.put(queryCacheKey,parsingResult);
    }
  }
 else {
    parsingResult=parse(jpqlString);
  }
  return new EmbeddedLuceneQuery(searchManager,parsingResult,startOffset,maxResults);
}
