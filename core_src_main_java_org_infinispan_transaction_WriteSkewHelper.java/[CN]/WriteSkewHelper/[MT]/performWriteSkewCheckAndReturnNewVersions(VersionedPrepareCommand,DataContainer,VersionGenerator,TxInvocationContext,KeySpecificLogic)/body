{
  EntryVersionsMap uv=new EntryVersionsMap();
  for (  WriteCommand c : prepareCommand.getModifications()) {
    for (    Object k : c.getAffectedKeys()) {
      if (ksl.performCheckOnKey(k)) {
        ClusteredRepeatableReadEntry entry=(ClusteredRepeatableReadEntry)context.lookupEntry(k);
        if (entry == null) {
          continue;
        }
        if (!context.isOriginLocal()) {
          EntryVersion versionSeen=prepareCommand.getVersionsSeen().get(k);
          if (versionSeen != null)           entry.setVersion(versionSeen);
        }
        if (entry.performWriteSkewCheck(dataContainer,context,c.wasPreviousRead())) {
          IncrementableEntryVersion newVersion=entry.isCreated() ? versionGenerator.generateNew() : versionGenerator.increment((IncrementableEntryVersion)entry.getVersion());
          uv.put(k,newVersion);
        }
 else {
          throw new WriteSkewException("Write skew detected on key " + k + " for transaction "+ context.getTransaction());
        }
      }
    }
  }
  return uv;
}
