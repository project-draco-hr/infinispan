{
switch (state) {
case READ_COMMAND:
    command=factory.createCommand(readLine(buffer));
  if (command.getType().isStorage())   checkpointer.checkpoint(State.READ_UNSTRUCTURED_DATA);
 else   return command;
break;
case READ_UNSTRUCTURED_DATA:
StorageCommand storageCmd=(StorageCommand)command;
byte[] data=new byte[storageCmd.getParams().getBytes()];
buffer.readBytes(data,0,data.length);
byte next=buffer.readByte();
if (next == CR) {
next=buffer.readByte();
if (next == LF) {
try {
return reset(storageCmd.setData(data));
}
 catch (IOException ioe) {
checkpointer.checkpoint(State.READ_COMMAND);
throw ioe;
}
}
 else {
throw new StreamCorruptedException("Expecting \r\n after data block");
}
}
 else {
throw new StreamCorruptedException("Expecting \r\n after data block");
}
}
return null;
}
