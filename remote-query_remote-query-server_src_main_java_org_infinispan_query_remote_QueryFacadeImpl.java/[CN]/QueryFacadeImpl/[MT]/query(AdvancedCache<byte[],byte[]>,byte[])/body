{
  try {
    SerializationContext serCtx=ProtobufMetadataManager.getSerializationContextInternal(cache.getCacheManager());
    QueryRequest request=ProtobufUtil.fromByteArray(serCtx,query,0,query.length,QueryRequest.class);
    Configuration cacheConfiguration=SecurityActions.getCacheConfiguration(cache);
    boolean isIndexed=cacheConfiguration.indexing().index().isEnabled();
    boolean isCompatMode=cacheConfiguration.compatibility().enabled();
    Query q=buildQuery(cache,serCtx,request,isIndexed,isCompatMode);
    QueryResponse response=makeResponse(isCompatMode,serCtx,q);
    return ProtobufUtil.toByteArray(serCtx,response);
  }
 catch (  IOException e) {
    throw log.errorExecutingQuery(e);
  }
}
