{
  EntityManager em=emf.createEntityManager();
  try {
    CriteriaBuilder cb=em.getCriteriaBuilder();
    CriteriaQuery cq=cb.createQuery(config.getEntityClass());
    cq.select(cq.from(config.getEntityClass()));
    TypedQuery q=em.createQuery(cq);
    Iterator it=q.getResultList().iterator();
    for (; it.hasNext(); ) {
      Object o=it.next();
      marshaller.objectToObjectStream(o,oos);
    }
    marshaller.objectToObjectStream(BINARY_STREAM_DELIMITER,oos);
  }
 catch (  IOException e) {
    throw new CacheLoaderException("IO Exception in toStreamLockSafe",e);
  }
 finally {
    em.close();
  }
}
