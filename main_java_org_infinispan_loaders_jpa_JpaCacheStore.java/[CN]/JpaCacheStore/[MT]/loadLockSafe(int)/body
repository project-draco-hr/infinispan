{
  if (maxEntries == 0)   return InfinispanCollections.emptySet();
  EntityManager em=emf.createEntityManager();
  try {
    CriteriaBuilder cb=em.getCriteriaBuilder();
    CriteriaQuery cq=cb.createQuery(config.getEntityClass());
    cq.select(cq.from(config.getEntityClass()));
    TypedQuery q=em.createQuery(cq);
    if (maxEntries > 0)     q.setMaxResults(maxEntries);
    List list=q.getResultList();
    if (list == null || list.isEmpty()) {
      return Collections.emptySet();
    }
    PersistenceUnitUtil util=emf.getPersistenceUnitUtil();
    Set<InternalCacheEntry> result=new HashSet<InternalCacheEntry>(list.size());
    for (    Object o : list) {
      Object key=util.getIdentifier(o);
      result.add(new ImmortalCacheEntry(key,o));
    }
    return result;
  }
  finally {
    em.close();
  }
}
