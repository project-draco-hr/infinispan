{
  cm.removeListener(listener);
  lockBreakingService.shutdownNow();
  if (trace)   log.trace("Wait for on-going transactions to finish for %d seconds.",TimeUnit.MILLISECONDS.toSeconds(configuration.getCacheStopTimeout()));
  long failTime=System.currentTimeMillis() + configuration.getCacheStopTimeout();
  boolean txsOnGoing=areTxsOnGoing();
  while (txsOnGoing && System.currentTimeMillis() < failTime) {
    try {
      Thread.sleep(100);
      txsOnGoing=areTxsOnGoing();
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      if (trace) {
        log.trace("Interrupted waiting for on-going transactions to finish. localTransactions=%s, remoteTransactions%s",localTransactions,remoteTransactions);
      }
    }
  }
  if (txsOnGoing) {
    log.warn("Stopping but there're transactions that did not finish in time: localTransactions=%s, remoteTransactions%s",localTransactions,remoteTransactions);
  }
 else {
    if (trace)     log.trace("All transactions terminated");
  }
}
