{
  boolean doCommit;
  status=Status.STATUS_PREPARING;
  try {
    boolean outcome=notifyBeforeCompletion();
    if (outcome && status != Status.STATUS_MARKED_ROLLBACK) {
      status=Status.STATUS_COMMITTING;
      doCommit=true;
    }
 else {
      status=Status.STATUS_ROLLING_BACK;
      doCommit=false;
    }
    notifyAfterCompletion(doCommit ? Status.STATUS_COMMITTED : Status.STATUS_MARKED_ROLLBACK);
    status=doCommit ? Status.STATUS_COMMITTED : Status.STATUS_MARKED_ROLLBACK;
    if (!doCommit)     throw new RollbackException("outcome is " + outcome + " status: "+ status);
  }
  finally {
    tm_.setTransaction(null);
  }
}
