{
  waitForView(viewId);
  if (isShuttingDown) {
    log.debugf("Ignoring join request from %s for cache %s, the local cache manager is shutting down",joiner,cacheName);
    return null;
  }
  ClusterCacheStatus cacheStatus=initCacheStatusIfAbsent(cacheName,joinInfo);
  boolean hadEmptyConsistentHashes;
synchronized (cacheStatus) {
    hadEmptyConsistentHashes=cacheStatus.getCacheTopology().getMembers().isEmpty();
    cacheStatus.addMember(joiner);
    if (hadEmptyConsistentHashes) {
      int newTopologyId=cacheStatus.getCacheTopology().getTopologyId() + 1;
      List<Address> initialMembers=cacheStatus.getMembers();
      ConsistentHash initialCH=joinInfo.getConsistentHashFactory().create(joinInfo.getHashFunction(),joinInfo.getNumOwners(),joinInfo.getNumSegments(),initialMembers);
      CacheTopology initialTopology=new CacheTopology(newTopologyId,initialCH,null);
      cacheStatus.updateCacheTopology(initialTopology);
    }
 else {
    }
  }
  if (hadEmptyConsistentHashes) {
    rebalancePolicy.initCache(cacheName,cacheStatus);
  }
 else {
    rebalancePolicy.updateCacheStatus(cacheName,cacheStatus);
  }
  return cacheStatus.getCacheTopology();
}
