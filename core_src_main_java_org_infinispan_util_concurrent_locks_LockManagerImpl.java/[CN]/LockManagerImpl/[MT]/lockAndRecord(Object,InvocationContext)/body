{
  long lockTimeout=getLockAcquisitionTimeout(ctx);
  if (trace)   log.trace("Attempting to lock {0} with acquisition timeout of {1} millis",key,lockTimeout);
  if (lockContainer.acquireLock(key,lockTimeout,MILLISECONDS) != null) {
    if (ctx instanceof TxInvocationContext) {
      TxInvocationContext tctx=(TxInvocationContext)ctx;
      if (!tctx.isRunningTransactionValid()) {
        Transaction tx=tctx.getRunningTransaction();
        log.debug("Successfully acquired lock, but the transaction {0} is no longer valid!  Releasing lock.",tx);
        lockContainer.releaseLock(key);
        throw new IllegalStateException("Transaction " + tx + " appears to no longer be valid!");
      }
    }
    if (trace)     log.trace("Successfully acquired lock!");
    return true;
  }
  return false;
}
