{
  org.apache.lucene.search.Query filteredQuery=filterQueryByClasses(luceneQuery);
  buildFilters();
  QueryHits queryHits;
  boolean stats=searchFactoryImplementor.getStatistics().isStatisticsEnabled();
  long startTime=0;
  if (stats) {
    startTime=System.nanoTime();
  }
  if (n == null) {
    queryHits=new QueryHits(searcher,filteredQuery,filter,sort,getTimeoutManagerImpl(),facetManager.getFacetRequests(),useFieldCacheOnTypes(),getAppropriateIdFieldCollectorFactory());
  }
 else   if (0 == n) {
    queryHits=new QueryHits(searcher,filteredQuery,filter,null,0,getTimeoutManagerImpl(),null,false,null);
  }
 else {
    queryHits=new QueryHits(searcher,filteredQuery,filter,sort,n,getTimeoutManagerImpl(),facetManager.getFacetRequests(),useFieldCacheOnTypes(),getAppropriateIdFieldCollectorFactory());
  }
  resultSize=queryHits.getTotalHits();
  if (stats) {
    searchFactoryImplementor.getStatisticsImplementor().searchExecuted(filteredQuery.toString(),System.nanoTime() - startTime);
  }
  facetManager.setFacetResults(queryHits.getFacets());
  return queryHits;
}
