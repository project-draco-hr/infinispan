{
  Channel ch=ctx.getChannel();
  ChannelBuffers buffers=ctx.getChannelBuffers();
  Value old=(Value)cache.get(key);
  if (old != null) {
    String prev=old.getData().length == 0 ? "0" : new String(old.getData());
    BigInteger newBigInt=operate(new BigInteger(prev),new BigInteger(delta));
    byte[] newData=newBigInt.toString().getBytes();
    Value curr=new Value(old.getFlags(),newData,old.getCas() + 1);
    boolean replaced=cache.replace(key,old,curr);
    if (replaced && !noReply) {
      ch.write(buffers.wrappedBuffer(buffers.wrappedBuffer(newData),buffers.wrappedBuffer(CRLF)));
    }
 else     if (!replaced) {
      throw new CacheException("Value modified since we retrieved from the cache, old value was " + prev);
    }
    return curr;
  }
 else {
    if (!noReply) {
      ch.write(buffers.wrappedBuffer(buffers.wrappedBuffer(Reply.NOT_FOUND.bytes()),buffers.wrappedBuffer(CRLF)));
    }
    return Reply.NOT_FOUND;
  }
}
