{
  if (trace)   log.tracef("Doing a remote get for key %s",key);
  boolean acquireRemoteLock=false;
  if (ctx.isInTxScope()) {
    TxInvocationContext txContext=(TxInvocationContext)ctx;
    acquireRemoteLock=isWrite && isPessimisticCache && !txContext.getAffectedKeys().contains(key);
  }
  InternalCacheEntry ice=dm.retrieveFromRemoteSource(key,ctx,acquireRemoteLock);
  if (acquireRemoteLock) {
    ((TxInvocationContext)ctx).addAffectedKey(key);
  }
  if (ice != null) {
    if (storeInL1) {
      if (isL1CacheEnabled) {
        if (trace)         log.tracef("Caching remotely retrieved entry for key %s in L1",key);
        try {
          long lifespan=ice.getLifespan() < 0 ? configuration.getL1Lifespan() : Math.min(ice.getLifespan(),configuration.getL1Lifespan());
          PutKeyValueCommand put=cf.buildPutKeyValueCommand(ice.getKey(),ice.getValue(),lifespan,-1,ctx.getFlags());
          lockAndWrap(ctx,key,ice);
          invokeNextInterceptor(ctx,put);
        }
 catch (        Exception e) {
          log.infof("Unable to store entry %s in L1 cache",key);
          log.debug("Inability to store in L1 caused by",e);
        }
      }
 else {
        CacheEntry ce=ctx.lookupEntry(key);
        if (ce == null || ce.isNull() || ce.isLockPlaceholder() || ce.getValue() == null) {
          if (ce != null && ce.isChanged()) {
            ce.setValue(ice.getValue());
          }
 else {
            if (isWrite)             lockAndWrap(ctx,key,ice);
 else             ctx.putLookedUpEntry(key,ice);
          }
        }
      }
    }
 else {
      if (trace)       log.tracef("Not caching remotely retrieved entry for key %s in L1",key);
    }
    return ice.getValue();
  }
  return null;
}
