{
  TestResourceTracker.testThreadStarted(this);
  final CheckPoint checkPoint=new CheckPoint();
  String name1=TestResourceTracker.getNextNodeName();
  String name2=TestResourceTracker.getNextNodeName();
  JChannel ch1=createChannel(name1,0);
  JChannel ch2=createChannel(name2,1);
  EmbeddedCacheManager cm1=createCacheManager(name1,ch1);
  EmbeddedCacheManager cm2=createCacheManager(name2,ch2);
  assertEquals(ComponentStatus.INSTANTIATED,extractGlobalComponentRegistry(cm1).getStatus());
  replaceInboundInvocationHandler(cm1,checkPoint);
  assertEquals(ComponentStatus.INSTANTIATED,extractGlobalComponentRegistry(cm2).getStatus());
  replaceInboundInvocationHandler(cm2,checkPoint);
  log.debugf("Cache managers created. Starting the caches");
  Future<Object> repl1Future=fork(new CacheStartCallable(cm1,"repl"));
  Future<Object> repl2Future=fork(new CacheStartCallable(cm2,"repl"));
  Future<Object> dist1Future=fork(new CacheStartCallable(cm1,"dist"));
  Future<Object> dist2Future=fork(new CacheStartCallable(cm2,"dist"));
  checkPoint.awaitStrict("blocked_" + ch1.getAddress(),10,SECONDS);
  checkPoint.awaitStrict("blocked_" + ch2.getAddress(),10,SECONDS);
  checkPoint.trigger("unblocked_" + cm1.getAddress(),CheckPoint.INFINITE);
  checkPoint.trigger("unblocked_" + cm2.getAddress(),CheckPoint.INFINITE);
  repl1Future.get(10,SECONDS);
  repl2Future.get(10,SECONDS);
  dist1Future.get(10,SECONDS);
  dist2Future.get(10,SECONDS);
  Cache<String,String> c1r=cm1.getCache("repl");
  Cache<String,String> c1d=cm1.getCache("dist");
  Cache<String,String> c2r=cm2.getCache("repl");
  Cache<String,String> c2d=cm2.getCache("dist");
  blockUntilViewsReceived(10000,cm1,cm2);
  waitForRehashToComplete(c1r,c2r);
  waitForRehashToComplete(c1d,c2d);
  c1r.put("key","value");
  assertEquals("value",c2r.get("key"));
  c1d.put("key","value");
  assertEquals("value",c2d.get("key"));
}
