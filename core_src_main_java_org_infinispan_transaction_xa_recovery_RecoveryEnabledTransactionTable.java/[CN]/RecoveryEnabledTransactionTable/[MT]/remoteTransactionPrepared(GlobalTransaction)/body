{
  RecoveryAwareRemoteTransaction remoteTransaction=(RecoveryAwareRemoteTransaction)remoteTransactions.get(gtx);
  remoteTransaction.setPrepared(true);
  RemoteTransaction preparedTx=remoteTransactions.remove(remoteTransaction.getGlobalTransaction());
  if (preparedTx == null)   throw new IllegalStateException("This tx has just been prepared, cannot be missing from here!");
  recoveryManager.registerPreparedTransaction(remoteTransaction);
}
