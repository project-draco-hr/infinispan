{
  LocalTopologyManager component=TestingUtil.extractGlobalComponent(manager,LocalTopologyManager.class);
  LocalTopologyManager spyLtm=Mockito.spy(component);
  doAnswer(new Answer(){
    @Override public Object answer(    InvocationOnMock invocation) throws Throwable {
      CacheTopology topology=(CacheTopology)invocation.getArguments()[1];
      if (topology.getTopologyId() != currentTopologyId) {
        checkPoint.trigger("pre_topology_" + topology.getTopologyId() + "_on_"+ manager.getAddress());
        checkPoint.await("allow_topology_" + topology.getTopologyId() + "_on_"+ manager.getAddress(),10,TimeUnit.SECONDS);
      }
      Object result=invocation.callRealMethod();
      checkPoint.trigger("post_topology_" + topology.getTopologyId() + "_on_"+ manager.getAddress());
      return result;
    }
  }
).when(spyLtm).handleConsistentHashUpdate(eq(CacheContainer.DEFAULT_CACHE_NAME),any(CacheTopology.class),anyInt());
  TestingUtil.extractGlobalComponentRegistry(manager).registerComponent(spyLtm,LocalTopologyManager.class);
}
