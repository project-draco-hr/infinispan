{
  List<Class<?>> mbeanIspnClasses=getMBeanClasses();
  List<Class<?>> globalClasses=new ArrayList<Class<?>>();
  List<Class<?>> namedCacheClasses=new ArrayList<Class<?>>();
  for (  Class<?> clazz : mbeanIspnClasses) {
    Scope scope=clazz.getAnnotation(Scope.class);
    if (scope != null && scope.value() == Scopes.GLOBAL) {
      debug("Add as global class " + clazz);
      globalClasses.add(clazz);
    }
 else {
      debug("Add as named cache class " + clazz);
      namedCacheClasses.add(clazz);
    }
  }
  PluginGen pg=new PluginGen();
  Props root=new Props();
  root.setPluginName("Infinispan");
  root.setPluginDescription("Supports management and monitoring of Infinispan");
  root.setName("Infinispan Cache Manager");
  root.setPkg("org.infinispan.jopr");
  root.setDependsOnJmxPlugin(true);
  root.setDiscoveryClass("CacheManagerDiscovery");
  root.setComponentClass("CacheManagerComponent");
  root.setSingleton(false);
  root.setCategory(ResourceCategory.SERVICE);
  Set<TypeKey> servers=new HashSet<TypeKey>();
  servers.add(new TypeKey("JMX Server","JMX"));
  servers.add(new TypeKey("JBossAS Server","JBossAS"));
  servers.add(new TypeKey("JBossAS Server","JBossAS5"));
  root.setRunsInsides(servers);
  populateMetricsAndOperations(globalClasses,root,false);
  Props cache=new Props();
  cache.setName("Infinispan Cache");
  cache.setPkg("org.infinispan.jopr");
  cache.setDependsOnJmxPlugin(true);
  cache.setDiscoveryClass("CacheDiscovery");
  cache.setComponentClass("CacheComponent");
  cache.setSingleton(false);
  cache.setCategory(ResourceCategory.SERVICE);
  populateMetricsAndOperations(namedCacheClasses,cache,true);
  root.getChildren().add(cache);
  pg.createFile(root,"descriptor","rhq-plugin.xml","../../../src/main/resources/META-INF");
  copyFile(new File("../../../src/main/resources/META-INF/rhq-plugin.xml"),new File("../../../target/classes/META-INF/rhq-plugin.xml"));
  return true;
}
