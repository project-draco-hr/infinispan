{
  try {
    VisitableCommand commitCommand=onePhaseCommit ? buildPrepareCommand(gtx,modifications,true) : commandsFactory.buildCommitCommand(gtx);
    if (trace)     log.trace("Running commit for " + gtx);
    handleCommitRollback(ctx,commitCommand);
    if (onePhaseCommit)     transactionLog.logOnePhaseCommit(gtx,modifications);
 else     transactionLog.logCommit(gtx);
  }
 catch (  Throwable e) {
    log.warn("Commit failed.  Clearing stale locks.");
    try {
      cleanupStaleLocks(ctx);
    }
 catch (    RuntimeException re) {
      log.error("Unable to clear stale locks",re);
      throw re;
    }
catch (    Throwable e2) {
      log.error("Unable to clear stale locks",e2);
      throw new RuntimeException(e2);
    }
    if (e instanceof RuntimeException)     throw (RuntimeException)e;
 else     throw new RuntimeException("Commit failed.",e);
  }
}
