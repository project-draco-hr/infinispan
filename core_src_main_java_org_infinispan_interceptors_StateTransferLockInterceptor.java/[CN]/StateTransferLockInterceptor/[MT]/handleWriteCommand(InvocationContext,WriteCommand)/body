{
  if (!stateTransferLock.acquireForCommand(ctx,command)) {
    return signalStateTransferInProgress(ctx);
  }
  boolean release=true;
  try {
    return handleWithRetries(ctx,command,rpcTimeout);
  }
 catch (  StateTransferLockReacquisitionException e) {
    release=false;
    return signalStateTransferInProgress(ctx);
  }
 finally {
    if (release) {
      stateTransferLock.releaseForCommand(ctx,command);
    }
  }
}
