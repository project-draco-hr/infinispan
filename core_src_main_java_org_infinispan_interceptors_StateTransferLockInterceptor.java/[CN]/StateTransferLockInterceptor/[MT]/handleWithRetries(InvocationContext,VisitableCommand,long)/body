{
  long endNanos=timeoutMillis > 0 ? (System.nanoTime() + TimeUnit.MILLISECONDS.toNanos(timeoutMillis)) : Long.MAX_VALUE;
  while (true) {
    int newCacheViewId=-1;
    try {
      return invokeNextInterceptor(ctx,command);
    }
 catch (    StateTransferInProgressException e) {
      newCacheViewId=e.getNewCacheViewId();
      log.debugf("Caught StateTransferInProgressException, waiting for the state transfer %d to start",newCacheViewId);
    }
catch (    SuspectException e) {
      newCacheViewId=newCacheViewId + 1;
      log.debugf("Caught SuspectException, waiting for the state transfer %d to start",newCacheViewId);
    }
    if (endNanos < System.nanoTime()) {
      throw new TimeoutException("Timed out waiting for the state transfer to end");
    }
    stateTransferLock.waitForStateTransferToEnd(ctx,command,newCacheViewId);
  }
}
