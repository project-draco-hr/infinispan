{
  InvocationContext existing=icTl.get();
  if (tx != null) {
    LocalTxInvocationContext localContext;
    if ((existing == null) || !(existing instanceof LocalTxInvocationContext)) {
      localContext=new LocalTxInvocationContext();
      icTl.set(localContext);
    }
 else {
      localContext=(LocalTxInvocationContext)existing;
    }
    LocalTransaction localTransaction=transactionTable.getLocalTransaction(tx);
    localContext.setLocalTransaction(localTransaction);
    localContext.setTransaction(tx);
    return localContext;
  }
 else {
    throw new IllegalStateException("This is a tx cache!");
  }
}
