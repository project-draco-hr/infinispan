{
  User user1=new UserPB();
  user1.setId(1);
  user1.setName("John");
  user1.setSurname("Doe");
  user1.setGender(User.Gender.MALE);
  user1.setAge(22);
  user1.setAccountIds(new HashSet<Integer>(Arrays.asList(1,2)));
  user1.setNotes("Lorem ipsum dolor sit amet");
  User user2=new UserPB();
  user2.setId(2);
  user2.setName("Spider");
  user2.setSurname("Man");
  user2.setGender(User.Gender.MALE);
  user2.setAge(32);
  user2.setAccountIds(Collections.singleton(3));
  User user3=new UserPB();
  user3.setId(3);
  user3.setName("Spider");
  user3.setSurname("Woman");
  user3.setGender(User.Gender.FEMALE);
  user3.setAge(40);
  user3.setAccountIds(Collections.<Integer>emptySet());
  remoteCache.put("user" + user1.getId(),user1);
  remoteCache.put("user" + user2.getId(),user2);
  remoteCache.put("user" + user3.getId(),user3);
  assertEquals(3,remoteCache.size());
  QueryFactory qf=Search.getQueryFactory(remoteCache);
  Query query=qf.from(UserPB.class).select("age").having("age").lte(Expression.param("ageParam")).toBuilder().build().setParameter("ageParam",32);
  final BlockingQueue<String> joined=new LinkedBlockingQueue<String>();
  final BlockingQueue<String> left=new LinkedBlockingQueue<String>();
  ContinuousQueryListener<String,Object[]> listener=new ContinuousQueryListener<String,Object[]>(){
    @Override public void resultJoining(    String key,    Object[] value){
      joined.add(key);
    }
    @Override public void resultLeaving(    String key){
      left.add(key);
    }
  }
;
  ContinuousQuery<String,User> continuousQuery=Search.getContinuousQuery(remoteCache);
  continuousQuery.addContinuousQueryListener(query,listener);
  expectElementsInQueue(joined,2);
  expectElementsInQueue(left,0);
  user3.setAge(30);
  remoteCache.put("user" + user3.getId(),user3);
  expectElementsInQueue(joined,1);
  expectElementsInQueue(left,0);
  user1.setAge(40);
  user2.setAge(40);
  user3.setAge(40);
  remoteCache.put("user" + user1.getId(),user1);
  remoteCache.put("user" + user2.getId(),user2);
  remoteCache.put("user" + user3.getId(),user3);
  expectElementsInQueue(joined,0);
  expectElementsInQueue(left,3);
  remoteCache.clear();
  user1.setAge(21);
  user2.setAge(22);
  remoteCache.put("expiredUser1",user1,5,TimeUnit.MILLISECONDS);
  remoteCache.put("expiredUser2",user2,5,TimeUnit.MILLISECONDS);
  expectElementsInQueue(joined,2);
  expectElementsInQueue(left,0);
  TestingUtil.sleepThread(60);
  assertNull(remoteCache.get("expiredUser1"));
  assertNull(remoteCache.get("expiredUser2"));
  expectElementsInQueue(joined,0);
  expectElementsInQueue(left,2);
  continuousQuery.removeContinuousQueryListener(listener);
  user2.setAge(22);
  remoteCache.put("user" + user2.getId(),user2);
  expectElementsInQueue(joined,0);
  expectElementsInQueue(left,0);
}
