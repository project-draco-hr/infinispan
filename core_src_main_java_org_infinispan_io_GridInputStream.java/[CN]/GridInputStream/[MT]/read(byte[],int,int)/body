{
  int bytesRead=0;
  while (len > 0) {
    int bytesRemainingToRead=getBytesRemainingInChunk();
    if (bytesRemainingToRead == 0) {
      if (endReached)       return bytesRead > 0 ? bytesRead : -1;
      currentBuffer=fetchNextChunk();
      localIndex=0;
      if (currentBuffer == null)       return bytesRead > 0 ? bytesRead : -1;
 else       if (currentBuffer.length < chunkSize)       endReached=true;
      bytesRemainingToRead=getBytesRemainingInChunk();
    }
    int bytesToRead=Math.min(len,bytesRemainingToRead);
    System.arraycopy(currentBuffer,localIndex,b,off,bytesToRead);
    localIndex+=bytesToRead;
    off+=bytesToRead;
    len-=bytesToRead;
    bytesRead+=bytesToRead;
    index+=bytesToRead;
  }
  return bytesRead;
}
