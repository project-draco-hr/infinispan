{
  boolean l1Entry=false;
  if (metadata instanceof L1Metadata) {
    metadata=((L1Metadata)metadata).metadata();
    l1Entry=true;
  }
  InternalCacheEntry<K,V> e=entries.get(k);
  if (trace) {
    log.tracef("Creating new ICE for writing. Existing=%s, metadata=%s, new value=%s",e,metadata,v);
  }
  if (l1Entry) {
    e=entryFactory.createL1(k,v,metadata);
  }
 else   if (e != null) {
    e=entryFactory.update(e,v,metadata);
  }
 else {
    e=entryFactory.create(k,v,metadata);
  }
  if (trace)   log.tracef("Store %s in container",e);
  extendedMap.putAndActivate(e);
}
