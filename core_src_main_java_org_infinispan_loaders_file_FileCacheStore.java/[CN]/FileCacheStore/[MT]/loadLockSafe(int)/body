{
  Set<InternalCacheEntry> result=new HashSet<InternalCacheEntry>(max);
  for (  File bucketFile : root.listFiles()) {
    Bucket bucket=loadBucket(bucketFile);
    if (bucket != null) {
      if (bucket.removeExpiredEntries()) {
        updateBucket(bucket);
      }
      Iterator<? extends InternalCacheEntry> i=bucket.getStoredEntries().iterator();
      while (result.size() < max && i.hasNext())       result.add(i.next());
    }
    if (result.size() >= max)     break;
  }
  return result;
}
