{
  if (bytes.length == 0) {
    if (f.exists())     f.delete();
    return;
  }
  String path=f.getPath();
  FileChannel channel=streams.get(path);
  if (channel == null) {
    channel=createChannel(f);
    FileChannel existingChannel=streams.putIfAbsent(path,channel);
    if (existingChannel != null) {
      Util.close(channel);
      channel=existingChannel;
    }
  }
 else   if (!f.exists()) {
    f.createNewFile();
    FileChannel oldChannel=channel;
    channel=createChannel(f);
    boolean replaced=streams.replace(path,oldChannel,channel);
    if (replaced) {
      Util.close(oldChannel);
    }
 else {
      Util.close(channel);
      channel=streams.get(path);
    }
  }
  channel.write(ByteBuffer.wrap(bytes));
}
