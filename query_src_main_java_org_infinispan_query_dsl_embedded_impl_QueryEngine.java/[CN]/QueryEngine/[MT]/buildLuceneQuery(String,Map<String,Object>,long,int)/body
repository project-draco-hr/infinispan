{
  if (searchManager == null) {
    throw new IllegalStateException("Cannot run Lucene queries on a cache that does not have indexing enabled");
  }
  checkParameters(namedParameters);
  LuceneQueryParsingResult parsingResult=transformJpaToLucene(jpqlString,namedParameters);
  org.apache.lucene.search.Query luceneQuery=makeTypeQuery(parsingResult.getQuery(),parsingResult.getTargetEntityName());
  CacheQuery cacheQuery=searchManager.getQuery(luceneQuery,parsingResult.getTargetEntity());
  if (parsingResult.getSort() != null) {
    cacheQuery=cacheQuery.sort(parsingResult.getSort());
  }
  if (parsingResult.getProjections() != null && !parsingResult.getProjections().isEmpty()) {
    String[] projection=parsingResult.getProjections().toArray(new String[parsingResult.getProjections().size()]);
    cacheQuery=cacheQuery.projection(projection);
  }
  if (startOffset >= 0) {
    cacheQuery=cacheQuery.firstResult((int)startOffset);
  }
  if (maxResults > 0) {
    cacheQuery=cacheQuery.maxResults(maxResults);
  }
  return cacheQuery;
}
