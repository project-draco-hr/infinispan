{
  if (req.getMethod() != GET) {
    sendHttpResponse(ctx,req,new DefaultHttpResponse(HTTP_1_1,FORBIDDEN));
    return;
  }
  if (!connectionUpgraded && req.getUri().equalsIgnoreCase("/" + INFINISPAN_WS_JS_FILENAME)) {
    DefaultHttpResponse res=new DefaultHttpResponse(HTTP_1_1,OK);
    loadScriptToResponse(req,res);
    sendHttpResponse(ctx,req,res);
    return;
  }
 else {
    WebSocketServerHandshakerFactory wsFactory=new WebSocketServerHandshakerFactory(getWebSocketLocation(req),null,false);
    handshaker=wsFactory.newHandshaker(req);
    if (handshaker == null) {
      wsFactory.sendUnsupportedWebSocketVersionResponse(ctx.getChannel());
    }
 else {
      handshaker.handshake(ctx.getChannel(),req).addListener(new ChannelFutureListener(){
        @Override public void operationComplete(        ChannelFuture future) throws Exception {
          if (!future.isSuccess()) {
            Channels.fireExceptionCaught(future.getChannel(),future.getCause());
          }
 else {
            connectionUpgraded=true;
          }
        }
      }
);
    }
    return;
  }
}
