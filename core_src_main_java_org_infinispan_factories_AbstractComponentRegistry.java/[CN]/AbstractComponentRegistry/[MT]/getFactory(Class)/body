{
  Map<String,Class<? extends AbstractComponentFactory>> defaultFactoryMap=getDefaultFactoryMap();
  Class<? extends AbstractComponentFactory> cfClass=defaultFactoryMap.get(componentClass.getName());
  if (cfClass == null) {
    throwStackAwareConfigurationException("No registered default factory for component '" + componentClass + "' found!");
  }
  AbstractComponentFactory cf=getComponent(cfClass);
  if (cf == null) {
    cf=instantiateFactory(cfClass);
    if (cf == null)     throwStackAwareConfigurationException("Unable to locate component factory for component " + componentClass);
    registerComponent(cf,cfClass);
  }
  Component c=lookupComponent(cfClass,cfClass.getName());
  if (c.instance != cf)   throwStackAwareConfigurationException("Component factory " + cfClass + " incorrectly registered!");
  return cf;
}
