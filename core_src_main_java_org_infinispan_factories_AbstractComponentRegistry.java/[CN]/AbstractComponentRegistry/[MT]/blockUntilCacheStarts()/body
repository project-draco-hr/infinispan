{
  int pollFrequencyMS=20;
  final long startupWaitTime=getConfiguration().getStateRetrievalTimeout();
  final long startupWaitTimeNanos=TimeUnit.NANOSECONDS.convert(startupWaitTime,TimeUnit.MILLISECONDS);
  final long giveUpTime=System.nanoTime() + startupWaitTimeNanos;
  while (System.nanoTime() < giveUpTime) {
    if (state.allowInvocations())     break;
    Thread.sleep(pollFrequencyMS);
  }
  if (!state.allowInvocations())   throw new IllegalStateException("Cache not in STARTED state, even after waiting " + getConfiguration().getStateRetrievalTimeout() + " millis.");
}
