{
  if (readCh == null) {
    throw new IllegalStateException("No cache topology received yet");
  }
  Set<Integer> ownedSegments=readCh.getSegmentsForOwner(rpcManager.getAddress());
  if (!ownedSegments.containsAll(segments)) {
    segments.removeAll(ownedSegments);
    throw new IllegalArgumentException("Segments " + segments + " are not owned by "+ rpcManager.getAddress());
  }
  List<TransactionInfo> transactions=new ArrayList<TransactionInfo>();
  if (configuration.transaction().transactionMode().isTransactional()) {
    stateTransferLock.transactionsExclusiveLock();
    try {
      collectTransactionsToTransfer(transactions,transactionTable.getRemoteTransactions(),segments);
      collectTransactionsToTransfer(transactions,transactionTable.getLocalTransactions(),segments);
      if (trace) {
        log.tracef("Found %d transactions to transfer",transactions.size());
      }
    }
  finally {
      stateTransferLock.transactionsExclusiveUnlock();
    }
  }
  return transactions;
}
