{
  Map<Class<?>,DocumentBuilderIndexedEntity<?>> builders=searchFactoryImplementor.getDocumentBuildersIndexedEntities();
  List<DirectoryProvider> directories=new ArrayList<DirectoryProvider>();
  Set<String> idFieldNames=new HashSet<String>();
  Similarity searcherSimilarity=null;
  if (targetedEntities.size() == 0) {
    if (builders.isEmpty()) {
      throw new HibernateException("There are no mapped entities. Don't forget to add @Indexed to at least one class.");
    }
    for (    DocumentBuilderIndexedEntity builder : builders.values()) {
      searcherSimilarity=checkSimilarity(searcherSimilarity,builder);
      if (builder.getIdKeywordName() != null) {
        idFieldNames.add(builder.getIdKeywordName());
        allowFieldSelectionInProjection=allowFieldSelectionInProjection && builder.allowFieldSelectionInProjection();
      }
      final DirectoryProvider[] directoryProviders=builder.getDirectoryProviderSelectionStrategy().getDirectoryProvidersForAllShards();
      populateDirectories(directories,directoryProviders);
    }
    classesAndSubclasses=null;
  }
 else {
    Set<Class<?>> involvedClasses=new HashSet<Class<?>>(targetedEntities.size());
    involvedClasses.addAll(targetedEntities);
    for (    Class<?> clazz : targetedEntities) {
      DocumentBuilderIndexedEntity<?> builder=builders.get(clazz);
      if (builder != null) {
        involvedClasses.addAll(builder.getMappedSubclasses());
      }
    }
    for (    Class clazz : involvedClasses) {
      DocumentBuilderIndexedEntity builder=builders.get(clazz);
      if (builder == null) {
        throw new HibernateException("Not a mapped entity (don't forget to add @Indexed): " + clazz);
      }
      if (builder.getIdKeywordName() != null) {
        idFieldNames.add(builder.getIdKeywordName());
        allowFieldSelectionInProjection=allowFieldSelectionInProjection && builder.allowFieldSelectionInProjection();
      }
      final DirectoryProvider[] directoryProviders=builder.getDirectoryProviderSelectionStrategy().getDirectoryProvidersForAllShards();
      searcherSimilarity=checkSimilarity(searcherSimilarity,builder);
      populateDirectories(directories,directoryProviders);
    }
    this.classesAndSubclasses=involvedClasses;
  }
  this.idFieldNames=idFieldNames;
  if (classesAndSubclasses != null) {
    for (    DirectoryProvider dp : directories) {
      final Set<Class<?>> classesInDirectoryProvider=searchFactoryImplementor.getClassesInDirectoryProvider(dp);
      if (classesInDirectoryProvider.size() > 1) {
        for (        Class clazz : classesInDirectoryProvider) {
          if (!classesAndSubclasses.contains(clazz)) {
            this.needClassFilterClause=true;
            break;
          }
        }
      }
      if (this.needClassFilterClause) {
        break;
      }
    }
  }
  final DirectoryProvider[] directoryProviders=directories.toArray(new DirectoryProvider[directories.size()]);
  IndexSearcher is=new IndexSearcher(searchFactoryImplementor.getReaderProvider().openReader(directoryProviders));
  is.setSimilarity(searcherSimilarity);
  return is;
}
