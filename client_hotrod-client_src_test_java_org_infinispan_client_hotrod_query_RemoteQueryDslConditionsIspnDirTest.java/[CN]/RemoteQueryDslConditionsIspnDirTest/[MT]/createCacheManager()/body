{
  ConfigurationBuilder builder=getConfigurationBuilder();
  cacheManager=TestCacheManagerFactory.createCacheManager(builder);
  ConfigurationBuilder defaultCacheConfiguration=new ConfigurationBuilder();
  cacheManager.defineConfiguration(InfinispanIntegration.DEFAULT_INDEXESDATA_CACHENAME,defaultCacheConfiguration.build());
  cacheManager.defineConfiguration(InfinispanIntegration.DEFAULT_LOCKING_CACHENAME,defaultCacheConfiguration.build());
  cacheManager.defineConfiguration(InfinispanIntegration.DEFAULT_INDEXESMETADATA_CACHENAME,defaultCacheConfiguration.build());
  cache=cacheManager.getCache();
  hotRodServer=TestHelper.startHotRodServer(cacheManager);
  org.infinispan.client.hotrod.configuration.ConfigurationBuilder clientBuilder=new org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
  clientBuilder.addServer().host("127.0.0.1").port(hotRodServer.getPort());
  clientBuilder.marshaller(new ProtoStreamMarshaller());
  remoteCacheManager=new RemoteCacheManager(clientBuilder.build());
  remoteCache=remoteCacheManager.getCache();
  cacheManager.getGlobalComponentRegistry().getComponent(ProtobufMetadataManager.class).registerProtofile("/bank.protobin");
  MarshallerRegistration.registerMarshallers(ProtoStreamMarshaller.getSerializationContext(remoteCacheManager));
  return cacheManager;
}
