{
  Transaction transaction=((TxInvocationContext)ctx).getTransaction();
  if (transaction == null)   throw new IllegalStateException("This should only be called in an tx scope");
  int status=transaction.getStatus();
  if (isNotValid(status))   throw new IllegalStateException("Transaction " + transaction + " is not in a valid state to be invoking cache operations on.");
  LocalTransaction localTransaction=txTable.getOrCreateLocalTransaction(transaction,ctx);
  txTable.enlist(transaction,localTransaction);
  return localTransaction;
}
