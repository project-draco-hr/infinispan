{
  if (!ctx.isOriginLocal()) {
    for (    VisitableCommand modification : command.getModifications()) {
      VisitableCommand toReplay=getCommandToReplay(modification);
      if (toReplay != null) {
        try {
          invokeNextInterceptor(ctx,toReplay);
        }
 catch (        Exception e) {
          if (command.isOnePhaseCommit())           markCompleted(ctx,command.getGlobalTransaction(),false);
          throw e;
        }
      }
    }
  }
  if (!command.isOnePhaseCommit()) {
    transactionLog.logPrepare(command);
  }
  if (this.statisticsEnabled)   prepares.incrementAndGet();
  Object result=invokeNextInterceptor(ctx,command);
  if (command.isOnePhaseCommit()) {
    transactionLog.logOnePhaseCommit(ctx.getGlobalTransaction(),command.getModifications());
  }
  if (!ctx.isOriginLocal()) {
    if (command.isOnePhaseCommit()) {
      markCompleted(ctx,command.getGlobalTransaction(),true);
    }
 else {
      txTable.remoteTransactionPrepared(command.getGlobalTransaction());
    }
  }
  return result;
}
