{
  LocalTransaction localTransaction=null;
  if (shouldEnlist(ctx)) {
    localTransaction=enlist((TxInvocationContext)ctx);
    if (command.hasFlag(Flag.PUT_FOR_STATE_TRANSFER)) {
      localTransaction.setFromStateTransfer(true);
    }
    boolean implicitWith1Pc=useOnePhaseForAutoCommitTx && localTransaction.isImplicitTransaction();
    if (implicitWith1Pc) {
      command.setFlags(Flag.SKIP_LOCKING);
    }
  }
  Object rv;
  try {
    rv=invokeNextInterceptor(ctx,command);
  }
 catch (  Throwable throwable) {
    if (ctx.isOriginLocal() && ctx.isInTxScope() && !command.hasFlag(Flag.FAIL_SILENTLY)) {
      TxInvocationContext txCtx=(TxInvocationContext)ctx;
      txCtx.getTransaction().setRollbackOnly();
    }
    throw throwable;
  }
  if (localTransaction != null && (command.isSuccessful() || useWriteSkew)) {
    localTransaction.addModification(command);
  }
  return rv;
}
