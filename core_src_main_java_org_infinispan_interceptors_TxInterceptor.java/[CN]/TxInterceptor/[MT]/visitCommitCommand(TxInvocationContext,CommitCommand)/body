{
  GlobalTransaction gtx=ctx.getGlobalTransaction();
  if (!ctx.isOriginLocal()) {
    if (txTable.isTransactionCompleted(gtx)) {
      if (trace)       log.tracef("Transaction %s already completed, skipping commit",gtx);
      return null;
    }
    if (!isTotalOrder) {
      RemoteTransaction remoteTx=(RemoteTransaction)ctx.getCacheTransaction();
      if (trace) {
        log.tracef("Remote tx topology id %d and command topology is %d",remoteTx.lookedUpEntriesTopology(),command.getTopologyId());
      }
      if (remoteTx.lookedUpEntriesTopology() < command.getTopologyId()) {
        PrepareCommand prepareCommand;
        if (useVersioning) {
          prepareCommand=commandsFactory.buildVersionedPrepareCommand(ctx.getGlobalTransaction(),ctx.getModifications(),false);
        }
 else {
          prepareCommand=commandsFactory.buildPrepareCommand(ctx.getGlobalTransaction(),ctx.getModifications(),false);
        }
        commandsFactory.initializeReplicableCommand(prepareCommand,true);
        prepareCommand.setOrigin(ctx.getOrigin());
        if (trace)         log.tracef("Replaying the transactions received as a result of state transfer %s",prepareCommand);
        visitPrepareCommand(ctx,prepareCommand);
      }
    }
  }
  if (this.statisticsEnabled)   commits.incrementAndGet();
  Object result=invokeNextInterceptor(ctx,command);
  if (!ctx.isOriginLocal() || isTotalOrder) {
    txTable.remoteTransactionCommitted(gtx,false);
  }
  return result;
}
